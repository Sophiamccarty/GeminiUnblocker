<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOPHIAS LORE-BARY</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #A08FD5; /* Helles Lila */
            --primary-dark: #8A78B4; /* Dunkleres Lila */
            --secondary-color: #88C0D0; /* Helles Blaugrün - bleibt vorerst, kann später angepasst werden */
            --accent-color: #BF616A; /* Sanftes Rot */
            --success-color: #A3BE8C; /* Sanftes Grün */
            --error-color: #BF616A; /* Sanftes Rot (gleich wie Akzent für Konsistenz) */
            --warning-color: #EBCB8B; /* Sanftes Gelb */
            --light-color: #ECEFF4; /* Sehr helles Grau */
            --medium-gray: #D8DEE9;
            --dark-gray: #4C566A;
            --text-color: #2E3440; /* Dunkles Grau für Text */
            --background-color: #F8F9FA; /* Heller Hintergrund */
            --border-radius: 10px; /* Erhöht für mehr Rundung */
            --box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            --font-main: 'Roboto', sans-serif;
            --font-headings: 'Montserrat', sans-serif;
            --primary-color-rgb: 160, 143, 213; /* Entspricht #A08FD5 */
            --dark-gray-rgb: 76, 86, 106; /* Entspricht #4C566A */
        }

        body {
            font-family: var(--font-main);
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1300px; /* Etwas breiter für modernes Layout */
            margin: 0 auto;
            padding: 25px;
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: var(--box-shadow);
            margin-bottom: 35px; /* Etwas mehr Abstand */
            padding: 15px 0; /* Angepasstes Padding */
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1300px; /* Passend zum .container */
            margin: 0 auto;
            padding: 0 25px; /* Passend zum .container */
        }

        .header h1 {
            margin: 0;
            font-family: var(--font-headings);
            font-size: 26px; /* Etwas größer */
            font-weight: 600;
        }

        .header-nav {
            display: flex;
            gap: 20px; /* Etwas mehr Abstand zwischen Links */
        }

        .header-nav a {
            color: var(--light-color); /* Hellere Farbe für besseren Kontrast auf dunklem Header */
            text-decoration: none;
            padding: 8px 15px; /* Größeres Padding */
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-weight: 500;
        }

        .header-nav a:hover, .header-nav a.active {
            background-color: var(--primary-dark); /* Dunklerer Hintergrund beim Hover/Aktiv */
            color: white; /* Weißer Text für aktiven Link */
        }

        .main-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 35px; /* Etwas mehr Padding */
            margin-bottom: 35px; /* Etwas mehr Abstand */
        }

        h2 {
            font-family: var(--font-headings);
            color: var(--primary-dark); /* Dunklere Primärfarbe für bessere Lesbarkeit */
            margin-top: 0;
            margin-bottom: 25px; /* Mehr Abstand nach der Überschrift */
            border-bottom: 2px solid var(--medium-gray); /* Subtilere Trennlinie */
            padding-bottom: 15px; /* Mehr Padding unter der Überschrift */
            font-size: 22px; /* Angepasste Größe */
            font-weight: 600;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--medium-gray); /* Etwas stärkere Linie */
        }

        .tab {
            padding: 12px 22px; /* Mehr Padding */
            cursor: pointer;
            border: none; /* Keine Ränder standardmäßig */
            border-bottom: 2px solid transparent; /* Platzhalter für aktiven Zustand */
            margin-bottom: -2px; /* Überlappt die untere Border des Containers */
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: 600;
            color: var(--primary-color);
        }

        .tab:hover:not(.active) {
            background-color: var(--light-color); /* Heller Hintergrund beim Hover */
            color: var(--primary-dark);
        }

        .tab-content {
            display: none;
            padding: 25px; /* Mehr Padding */
            border: 1px solid var(--medium-gray);
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius); /* Abrundung nur unten */
            background-color: white; /* Sicherstellen, dass der Hintergrund weiß ist */
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 10px; /* Mehr Abstand */
            font-weight: 500; /* Etwas leichter */
            color: var(--dark-gray); /* Dunkleres Grau für Label-Text */
            font-size: 15px;
        }

        input[type="text"],
        input[type="search"],
        textarea {
            width: 100%;
            padding: 12px 15px; /* Mehr Padding */
            border: 1px solid var(--medium-gray); /* Subtilerer Rand */
            border-radius: var(--border-radius);
            font-size: 15px;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-sizing: border-box; /* Wichtig für konsistente Größen */
            background-color: #fff; /* Sicherstellen, dass der Hintergrund weiß ist */
        }

        input[type="text"]:focus,
        input[type="search"]:focus,
        textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb, 94, 129, 172), 0.25); /* RGB-Wert für primary-color muss hier ggf. angepasst werden */
        }

        textarea {
            min-height: 120px; /* Etwas weniger Höhe */
            font-family: var(--font-main); /* Gleiche Schriftart wie Rest */
            resize: vertical; /* Nur vertikales Resizing erlauben */
        }

        button, .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 18px; /* Angepasstes Padding */
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none; /* Für .button als Link */
        }

        button:hover, .button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px); /* Leichter Hover-Effekt */
        }
        
        button:active, .button:active {
            transform: translateY(0px); /* Klick-Effekt */
        }

        button i, .button i {
            margin-right: 8px;
            font-size: 1.1em; /* Icons etwas größer */
        }

        .button-group {
            display: flex;
            gap: 12px; /* Etwas mehr Abstand */
            margin-top: 25px; /* Etwas mehr Abstand */
        }

        .success-button {
            background-color: var(--success-color);
        }

        .success-button:hover {
            background-color: #8FB07B; /* Dunklere Variante von --success-color */
        }

        .error-button {
            background-color: var(--error-color);
        }

        .error-button:hover {
            background-color: #AC5259; /* Dunklere Variante von --error-color */
        }

        .secondary-button {
            background-color: var(--secondary-color);
            color: var(--text-color); /* Besserer Kontrast für helles Blaugrün */
        }

        .secondary-button:hover {
            background-color: #79A8B5; /* Dunklere Variante von --secondary-color */
            color: var(--text-color);
        }

/* Redesign card buttons to be more compact */
        .card .outline-button,
        .card .button {
            padding: 6px 12px;
            font-size: 13px;
            white-space: nowrap;
        }

        .outline-button:hover {
            background-color: rgba(var(--primary-color-rgb), 0.1); /* Leichter Hintergrund beim Hover */
            color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .alert {
            padding: 18px 22px; /* Mehr Padding */
            margin-bottom: 25px; /* Mehr Abstand */
            border-radius: var(--border-radius);
            border-width: 1px;
            border-style: solid;
            font-size: 15px;
        }

        .alert-success {
            background-color: #EBF5E9; /* Helleres Grün */
            color: #3A6839; /* Dunkleres Grün für Text */
            border-color: var(--success-color);
        }

        .alert-error {
            background-color: #FBEAEB; /* Helleres Rot */
            color: #7D3C42; /* Dunkleres Rot für Text */
            border-color: var(--error-color);
        }

        .alert-warning {
            background-color: #FEF8E7; /* Helleres Gelb */
            color: #8A6D3B; /* Dunkleres Gelb für Text */
            border-color: var(--warning-color);
        }

        .alert-info {
            background-color: #E8F3F6; /* Helleres Blau */
            color: #3E6D7A; /* Dunkleres Blau für Text */
            border-color: var(--secondary-color);
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--medium-gray); /* Subtilerer Rand */
            padding: 25px; /* Mehr Padding */
            margin-bottom: 25px; /* Mehr Abstand */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: var(--box-shadow); /* Standard-Schatten */
        }

        .card:hover {
            transform: translateY(-3px); /* Etwas stärkerer Hover-Effekt */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); /* Angepasster Hover-Schatten */
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Bessere Ausrichtung für längere Titel */
            margin-bottom: 18px; /* Mehr Abstand */
            padding-bottom: 12px;
            border-bottom: 1px solid var(--light-color);
        }

        .card-title {
            font-family: var(--font-headings);
            font-size: 20px; /* Größerer Titel */
            font-weight: 600;
            color: var(--primary-dark); /* Dunklere Primärfarbe */
            margin: 0;
        }

        .card-body {
            color: var(--text-color); /* Konsistente Textfarbe */
            font-size: 15px;
        }

        .card-description {
            margin-bottom: 18px; /* Mehr Abstand */
            font-size: 15px; /* Etwas größer */
            line-height: 1.6;
        }

/* Completely redesign the card footer layout */
        .card-footer {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--light-color);
            font-size: 14px;
            color: var(--dark-gray);
            flex-wrap: wrap;
            gap: 10px;
        }
/* Create action container for buttons */
        .card-footer-actions {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            margin-left: auto;
        }
        .card-footer-right-group {
            display: flex;
            align-items: center;
            gap: 15px; /* Abstand zwischen Ratings und Button-Gruppe */
            flex-shrink: 0; /* Verhindert, dass diese Gruppe schrumpft */
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* Mehr Abstand zwischen Tags */
            margin: 15px 0; /* Mehr vertikaler Abstand */
        }

        .tag {
            background-color: var(--light-color); /* Heller Hintergrund */
            color: var(--primary-dark); /* Dunklere Primärfarbe für Text */
            padding: 5px 10px; /* Mehr Padding */
            border-radius: var(--border-radius);
            font-size: 13px; /* Etwas größer */
            font-weight: 500;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px; /* Mehr Padding */
            border-radius: var(--border-radius); /* Konsistente Rundung */
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase; /* Für besseren Badge-Look */
            letter-spacing: 0.5px;
        }

        .badge-primary {
            background-color: var(--primary-color); /* Primärfarbe als Hintergrund */
            color: white; /* Weißer Text */
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: var(--text-color); /* Dunkler Text auf hellem Gelb */
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .search-container {
            margin-bottom: 35px; /* Mehr Abstand */
            background-color: #fff;
            padding: 25px; /* Mehr Padding */
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .search-form {
            display: flex;
            gap: 12px; /* Mehr Abstand */
        }

        .search-form input[type="search"] {
            flex-grow: 1;
            /* Stile werden von globalen input-Styles geerbt */
        }
        .search-form button.search-button { /* Spezifischer Selektor */
             padding: 10px 18px; /* Konsistent mit anderen Buttons */
        }


        .filter-container {
            display: flex;
            flex-wrap: wrap; /* Umbruch bei vielen Filtern */
            gap: 10px;
            margin: 20px 0 0; /* Nur oberer Margin */
        }

        .filter-button {
            padding: 8px 15px; /* Mehr Padding */
            border-radius: var(--border-radius); /* Konsistente Rundung */
            font-size: 13px;
            background-color: var(--light-color);
            color: var(--dark-gray);
            border: 1px solid transparent; /* Platzhalter für aktiven Rand */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
        }

        .filter-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-dark);
            font-weight: 600;
        }

        .filter-button:hover:not(.active) {
            background-color: var(--medium-gray);
            color: var(--text-color);
        }

        .lorebook-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

/* Make code display more compact */
        .code-display {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            background-color: var(--light-color);
            padding: 4px 8px;
            border-radius: var(--border-radius);
            font-size: 12px;
            color: var(--accent-color);
            border: 1px solid var(--medium-gray);
            display: inline-block;
            min-width: auto;
            max-width: 130px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }

        .command-list dt {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            background-color: var(--primary-color); /* Geändert für bessere Sichtbarkeit */
            padding: 5px 10px;
            border-radius: var(--border-radius);
            font-size: 14px;
            color: white; /* Geändert für bessere Sichtbarkeit */
            border: 1px solid var(--primary-dark); /* Geändert für bessere Sichtbarkeit */
            margin-top: 15px;
            margin-bottom: 5px;
            display: block; /* Ensure dt takes full width */
            word-break: break-all; /* Break long commands */
            display: inline-block;
        }

        .command-list dd {
            margin-left: 20px;
            margin-bottom: 10px;
            padding-left: 15px;
            border-left: 3px solid var(--medium-gray);
        }
        .command-list dd ul {
            list-style-type: disc;
            margin-left: 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 35px; /* Mehr Abstand */
            gap: 5px; /* Abstand zwischen Buttons */
        }

        .pagination-button {
            padding: 8px 14px; /* Mehr Padding */
            border: 1px solid var(--medium-gray);
            color: var(--primary-color);
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border-radius: var(--border-radius); /* Individuelle Rundung für jeden Button */
            font-weight: 500;
        }

        .pagination-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-button:hover:not(.active) {
            background-color: var(--light-color);
            border-color: var(--primary-color);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 22px; /* Mehr Abstand */
        }

        .toggle-label {
            margin-right: 12px; /* Mehr Abstand */
            font-size: 15px;
            color: var(--dark-gray);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px; /* Etwas kleiner */
            height: 26px; /* Etwas höher für besseres Klicken */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--medium-gray); /* Helleres Grau für inaktiven Zustand */
            transition: .3s ease-in-out;
            border-radius: 26px; /* Vollständig abgerundet */
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px; /* Größerer Kreis */
            width: 20px;  /* Größerer Kreis */
            left: 3px;   /* Angepasste Position */
            bottom: 3px; /* Angepasste Position */
            background-color: white;
            transition: .3s ease-in-out;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        input:checked + .toggle-slider {
            background-color: var(--success-color); /* Erfolgsfarbe für aktivierten Toggle */
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px); /* Angepasste Translation */
        }

        .input-with-button {
            display: flex;
        }

        .input-with-button input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none; /* Verhindert doppelte Ränder */
        }

        .input-with-button button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .json-preview {
            background-color: var(--light-color); /* Hellerer Hintergrund */
            border-radius: var(--border-radius);
            padding: 15px; /* Mehr Padding */
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 13px; /* Etwas größer */
            color: var(--text-color);
            overflow: auto;
            max-height: 350px; /* Etwas mehr Höhe */
            border: 1px solid var(--medium-gray);
            line-height: 1.5;
        }

        .info-box {
            background-color: var(--light-color); /* Hellerer Hintergrund */
            border-left: 5px solid var(--secondary-color); /* Akzentfarbe für Rand */
            padding: 20px; /* Mehr Padding */
            margin: 25px 0; /* Mehr Abstand */
            border-radius: var(--border-radius); /* Einheitliche Rundung */
        }

        .info-box h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--primary-dark); /* Dunklere Primärfarbe */
            font-family: var(--font-headings);
            font-size: 18px;
        }
        .info-box p {
            font-size: 15px;
            line-height: 1.6;
        }

        .key-container {
            margin-bottom: 20px; /* Mehr Abstand */
        }

        .key-input-group {
            display: flex;
            gap: 8px; /* Weniger Abstand für kompaktere Gruppe */
            margin-bottom: 8px;
        }

        .key-input { /* Erbt von globalen input-Styles */
            flex-grow: 1;
        }

        .add-key-button { /* Erbt von globalen Button-Styles */
            padding: 8px 12px; /* Kleinerer Button */
            font-size: 14px;
        }

        .key-tag {
            display: inline-flex;
            align-items: center;
            background-color: var(--secondary-color); /* Sekundärfarbe für Tags */
            color: var(--text-color); /* Dunkler Text für Kontrast */
            padding: 6px 12px; /* Angepasstes Padding */
            border-radius: 15px; /* Stärkere Rundung für Tag-Look */
            font-size: 13px;
            margin: 0 6px 6px 0; /* Angepasster Margin */
            font-weight: 500;
        }

        .key-tag .remove-key {
            margin-left: 8px; /* Mehr Abstand zum Text */
            cursor: pointer;
            color: var(--dark-gray);
            font-weight: bold;
            transition: color 0.2s ease-in-out;
        }

        .key-tag .remove-key:hover {
            color: var(--error-color);
        }

        .help-text {
            font-size: 13px; /* Etwas kleiner */
            color: var(--dark-gray); /* Dunkleres Grau */
            margin-top: 8px; /* Mehr Abstand */
            display: block; /* Sicherstellen, dass es Platz einnimmt */
        }

        .entry-list {
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 25px; /* Mehr Abstand */
            background-color: white;
        }

        .entry-item {
            padding: 12px 18px; /* Mehr Padding */
            border-bottom: 1px solid var(--light-color); /* Hellere Trennlinie */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .entry-item:last-child {
            border-bottom: none;
        }

        .entry-item:hover {
            background-color: var(--light-color); /* Heller Hintergrund beim Hover */
        }

        .entry-item.active {
            background-color: rgba(var(--primary-color-rgb), 0.15); /* Leichter Primärfarben-Hintergrund */
            border-left: 4px solid var(--primary-color); /* Stärkerer linker Rand */
            padding-left: 14px; /* Ausgleich für den Rand */
        }

        .entry-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .entry-item-title {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 15px;
        }

        .entry-item-content {
            font-size: 13px; /* Etwas kleiner */
            color: var(--dark-gray);
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%; /* Verhindert Überlappung mit Badges */
        }

        .empty-state {
            text-align: center;
            padding: 50px 25px; /* Mehr Padding */
            color: var(--dark-gray); /* Dunkleres Grau */
            background-color: var(--light-color);
            border-radius: var(--border-radius);
        }

        .empty-state i {
            font-size: 52px; /* Größeres Icon */
            color: var(--medium-gray); /* Subtilere Farbe */
            margin-bottom: 20px; /* Mehr Abstand */
            display: block;
        }
        .empty-state p {
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 25px; /* Mehr Padding */
        }

        .spinner {
            border: 5px solid rgba(var(--dark-gray-rgb, 76, 86, 106), 0.15); /* RGB für dark-gray anpassen */
            border-radius: 50%;
            border-top: 5px solid var(--primary-color);
            width: 36px; /* Größerer Spinner */
            height: 36px; /* Größerer Spinner */
            animation: spin 0.8s linear infinite; /* Schnellere Animation */
            margin: 0 auto 18px; /* Mehr Abstand */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer styling */
        .footer {
            background-color: var(--dark-gray); /* Dunkleres Grau für Footer */
            color: var(--light-color); /* Heller Text */
            padding: 25px 0; /* Mehr Padding */
            margin-top: 50px; /* Mehr Abstand */
            font-size: 14px;
        }

        .footer-container {
            max-width: 1300px; /* Passend zum .container */
            margin: 0 auto;
            padding: 0 25px; /* Passend zum .container */
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Umbruch bei Bedarf */
            gap: 15px;
        }

        .footer-links {
            display: flex;
            gap: 20px; /* Mehr Abstand */
        }

        .footer-links a {
            color: var(--light-color);
            text-decoration: none;
            transition: color 0.2s ease-in-out;
        }

        .footer-links a:hover {
            color: var(--secondary-color); /* Akzentfarbe beim Hover */
            text-decoration: underline;
        }

        /* Creator-specific styles */
        .lorebook-creator {
            max-width: 1100px; /* Etwas breiter */
            margin: 0 auto;
        }

        .panel-container {
            display: flex;
            gap: 25px; /* Mehr Abstand */
            margin-bottom: 20px; /* Mehr Abstand */
        }

        .panel-left {
            flex: 1;
            min-width: 300px; /* Etwas breiter */
        }

        .panel-right {
            flex: 2.5; /* Mehr Platz für den Editor */
            min-width: 450px; /* Etwas breiter */
        }

        .creator-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px; /* Mehr Padding */
            margin-bottom: 20px; /* Mehr Abstand */
            box-shadow: var(--box-shadow);
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px; /* Mehr Abstand */
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-color);
        }

        .section-header i {
            font-size: 20px;
            color: var(--primary-color);
        }

        .section-header h3 {
            font-family: var(--font-headings);
            font-size: 19px; /* Etwas größer */
            font-weight: 600;
            margin: 0;
            padding: 0;
            margin-left: 12px; /* Mehr Abstand zum Icon */
            color: var(--primary-dark);
        }

        /* .entry-card wird durch .entry-item ersetzt und dessen Stile werden verwendet.
           Falls .entry-card noch separat benötigt wird, hier anpassen.
           Ich gehe davon aus, dass .entry-item die Funktionalität übernimmt. */
        /* .entry-card { ... } */
        /* .entry-card.selected { ... } */


        .creator-textarea { /* Erbt von globalen textarea-Styles */
            width: 100%;
            min-height: 150px; /* Mehr Höhe für Creator */
            margin-bottom: 18px; /* Mehr Abstand */
        }

        #keywordTags, #secondaryKeywordTags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* Mehr Abstand */
            margin-bottom: 15px; /* Mehr Abstand */
        }

        /* Responsive adjustments */
        @media (max-width: 992px) { /* Breiterer Breakpoint für Panel-Umbruch */
            .panel-container {
                flex-direction: column;
            }
            
            .panel-left, .panel-right {
                width: 100%;
                min-width: unset; /* Min-width aufheben für kleinere Bildschirme */
            }
        }
        @media (max-width: 768px) {
            .lorebook-grid {
                grid-template-columns: 1fr; /* Einspaltig auf kleineren Geräten */
            }
            .header-container {
                flex-direction: column;
                gap: 15px;
                padding: 10px 20px; /* Weniger Padding im Header auf Mobile */
            }
            .header h1 {
                font-size: 20px; /* Kleinere Schrift im Header */
            }
            .header-nav {
                gap: 8px; /* Weniger Abstand in Navi */
                justify-content: center;
                width: 100%;
                flex-wrap: wrap; /* Umbruch für Nav-Links */
            }
            .header-nav a {
                padding: 7px 9px; /* Kleineres Padding für Nav-Links */
                font-size: 13px; /* Kleinere Schrift für Nav-Links */
            }
            .footer-container {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            .container {
                padding: 15px; /* Weniger Padding im Hauptcontainer */
            }
            .main-content, .creator-card, .search-container {
                padding: 20px; /* Weniger Padding in Content-Blöcken */
            }
            h2 {
                font-size: 20px;
                margin-bottom: 20px;
                padding-bottom: 10px;
            }
            .card {
                padding: 20px;
            }
            .card-title {
                font-size: 18px;
            }
            .button, button {
                padding: 9px 15px;
                font-size: 14px;
            }
            .modal {
                max-width: calc(100% - 30px); /* Modal fast volle Breite mit kleinem Rand */
                max-height: calc(100vh - 30px);
            }
            .modal-header, .modal-body, .modal-footer {
                padding: 15px 20px;
            }
            .modal-title {
                font-size: 18px;
            }
        }

/* Make cards more responsive */
        @media (max-width: 500px) {
            .card-footer {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .card-footer-actions {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            
            .code-display {
                max-width: 100%;
                margin-bottom: 5px;
            }
        }

/* Add specific styles for lorebook grid cards */
        .lorebook-grid .card {
            display: flex;
            flex-direction: column;
        }

        .lorebook-grid .card-body {
            flex-grow: 1;
        }

        .lorebook-grid .card-footer {
            margin-top: auto;
        }
        
        /* Upload/file input styling */
        .file-input-container {
            position: relative;
            display: inline-block;
            /* Der Button darunter wird gestylt */
        }

        .file-input { /* Das eigentliche Input-Feld ist unsichtbar */
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Modal styles */
        .modal-background {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(var(--dark-gray-rgb), 0.75); /* Dunklerer Hintergrund mit RGB Variable */
            z-index: 1050; /* Höherer z-index für Modals */
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto; /* Scrollen für den Hintergrund, falls Modal zu groß */
        }

        .modal {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 600px; /* Etwas breiter für mehr Inhalt */
            max-height: calc(100vh - 40px); /* Höhe begrenzt durch Viewport mit Padding */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); /* Angepasster Schatten */
            display: flex;
            flex-direction: column;
            margin: auto; /* Zentriert das Modal, wenn der Hintergrund scrollt */
        }

        .modal-header {
            padding: 20px 25px; /* Konsistentes Padding */
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Verhindert Schrumpfen des Headers */
        }

        .modal-title {
            margin: 0;
            font-family: var(--font-headings);
            font-size: 20px;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px; /* Größer für bessere Klickbarkeit */
            cursor: pointer;
            color: var(--dark-gray);
            transition: color 0.2s ease-in-out, transform 0.2s ease;
            padding: 0; /* Kein extra Padding, da Größe über font-size */
            line-height: 1;
        }
        .modal-close:hover {
            color: var(--accent-color);
            transform: rotate(90deg); /* Leichte Drehung beim Hover */
        }

        .modal-body {
            padding: 25px;
            flex-grow: 1;
            overflow-y: auto; /* Scrollen innerhalb des Modal-Bodys */
            font-size: 15px;
            line-height: 1.65; /* Etwas mehr Zeilenhöhe */
        }
         .modal-body p {
            margin-top: 0;
            margin-bottom: 18px; /* Mehr Abstand */
        }
        .modal-body .help-text {
            font-size: 13px;
            margin-top: -12px;
            margin-bottom: 18px;
        }


        .modal-footer {
            padding: 20px 25px; /* Konsistentes Padding */
            border-top: 1px solid var(--medium-gray);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background-color: var(--background-color); /* Passend zum Body-Hintergrund */
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            flex-shrink: 0; /* Verhindert Schrumpfen des Footers */
        }
        .code-display-block {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--medium-gray);
        }
        .code-display-block span {
            color: var(--accent-color);
            word-break: break-all; /* Um lange URLs umzubrechen */
        }
        .code-display-block .copy-button {
            padding: 6px 12px;
            font-size: 13px;
            margin-left: 15px; /* Abstand zum Text */
        }
    </style>

    <style>
        .collapsible-menu {
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            background-color: #fff; /* Hintergrund für das Menü */
        }

        .collapsible-header {
            background-color: var(--light-color);
            color: var(--primary-dark);
            padding: 12px 18px;
            width: 100%;
            border: none;
            text-align: left;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: var(--border-radius) var(--border-radius) 0 0; /* Oben abgerundet */
        }

        .collapsible-header:hover {
            background-color: var(--medium-gray);
        }

        .collapsible-header i {
            transition: transform 0.3s ease;
        }

        .collapsible-header.active i {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 0px 18px; /* Padding oben/unten wird durch innere Elemente gesteuert */
            display: none;
            overflow: hidden;
            border-top: 1px solid var(--medium-gray);
            border-radius: 0 0 var(--border-radius) var(--border-radius); /* Unten abgerundet */
        }
        
        .collapsible-content dl dd {
            margin-left: 10px; /* Einzug für Beschreibungen */
            margin-bottom: 12px; /* Abstand zwischen den Einträgen */
            font-size: 14px;
        }

        .info-box.server-commands-container { /* Spezifische Klasse für schmaleres Layout */
            max-width: 800px; /* Maximale Breite für diesen Info-Box-Typ */
            margin-left: auto;
            margin-right: auto;
        }

        .copy-all-commands-button {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        .copy-all-commands-button:hover {
            background-color: #79A8B5; /* Dunklere Variante von --secondary-color */
        }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <h1>SOPHIAS LORE-BARY</h1>
            <nav class="header-nav">
                <a href="#" class="active" id="nav-home">Home</a>
                <a href="#" id="nav-creator">Creator</a>
                <a href="#" id="nav-proxy-info">Proxy Server</a>
                <a href="https://colab.research.google.com/drive/1Yo2EE1wH5RA7ZDWTinpX5EJggtoNftKo?usp=sharing#scrollTo=MivdkgP7jYSb" target="_blank">OpenRouter Colab</a>
                <a href="https://colab.research.google.com/drive/13xEzZjlxJb7P6ro1akrq-UAhuUDgbC2A?usp=sharing" target="_blank">AI Studio Colab</a>
                <a href="#" id="nav-help">Help</a>
            </nav>
        </div>
    </header>

    <!-- Main Content Container -->
    <div class="container">
        <!-- Home Page / Public Lorebooks -->
        <div id="home-page" class="main-content">
            <h2>Discover Public Lorebooks</h2>
            
            <div class="search-container">
                <div class="search-form">
                    <input type="search" id="lorebook-search" placeholder="Search by name, keywords, or description...">
                    <button class="search-button" id="search-button"><i class="fa fa-search"></i> Search</button>
                </div>
                
                <div class="filter-container">
                    <button class="filter-button active" data-filter="all">All</button>
                    <button class="filter-button" data-filter="popular">Popular</button>
                    <button class="filter-button" data-filter="newest">Newest</button>
                    <button class="filter-button" data-filter="fantasy">Fantasy</button>
                    <button class="filter-button" data-filter="sci-fi">Sci-Fi</button>
                    <button class="filter-button" data-filter="historical">Historical</button>
                </div>
            </div>
            
            <div id="lorebook-grid" class="lorebook-grid">
                <!-- Example lorebook cards -->
                <div class="card" data-category="fantasy popular">
                    <div class="card-header">
                        <h3 class="card-title">Middle Earth Handbook</h3>
                        <span class="badge badge-primary">Fantasy</span>
                    </div>
                    <div class="card-body">
                        <p class="card-description">Comprehensive guide to Tolkien's world including places, characters, and events.</p>
                        <div class="card-tags">
                            <span class="tag">Middle Earth</span>
                            <span class="tag">Tolkien</span>
                            <span class="tag">Lord of the Rings</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="code-display"><code>LORE:TLK421</code></div>
                        <button class="outline-button use-lorebook-button" data-code="TLK421">Use This Lorebook</button>
                    </div>
                </div>
                
                <div class="card" data-category="sci-fi new">
                    <div class="card-header">
                        <h3 class="card-title">Galactic Federation Database</h3>
                        <span class="badge badge-primary">Sci-Fi</span>
                    </div>
                    <div class="card-body">
                        <p class="card-description">Details on alien species, space stations, and interstellar politics.</p>
                        <div class="card-tags">
                            <span class="tag">Space</span>
                            <span class="tag">Aliens</span>
                            <span class="tag">Federation</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="code-display"><code>LORE:SPC789</code></div>
                        <button class="outline-button use-lorebook-button" data-code="SPC789">Use This Lorebook</button>
                    </div>
                </div>
                
                <div class="card" data-category="historical popular">
                    <div class="card-header">
                        <h3 class="card-title">Victorian Era Encyclopedia</h3>
                        <span class="badge badge-primary">Historical</span>
                    </div>
                    <div class="card-body">
                        <p class="card-description">Cultural, social, and historical context of Victorian England.</p>
                        <div class="card-tags">
                            <span class="tag">Victorian</span>
                            <span class="tag">19th Century</span>
                            <span class="tag">London</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="code-display"><code>LORE:VCT123</code></div>
                        <button class="outline-button use-lorebook-button" data-code="VCT123">Use This Lorebook</button>
                    </div>
                </div>
            </div>
            
            <div class="pagination">
                <button class="pagination-button">1</button>
                <button class="pagination-button">2</button>
                <button class="pagination-button">3</button>
                <button class="pagination-button">Next</button>
            </div>
        </div>
        
        <!-- Creator Page -->
        <div id="creator-page" class="main-content" style="display: none;">
            <h2>Lorebook Creator</h2>
            
            <div class="lorebook-creator">
                <!-- Creator Metadata -->
                <div class="creator-card">
                    <div class="section-header">
                        <i class="fa fa-book"></i>
                        <h3>Lorebook Information</h3>
                    </div>
                    
                    <div class="form-group">
                        <label for="lorebook-name">Lorebook Name:</label>
                        <input type="text" id="lorebook-name" placeholder="Enter a name for your lorebook">
                        <div class="help-text">A descriptive name for your lorebook</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="lorebook-description">Description:</label>
                        <textarea id="lorebook-description" placeholder="Describe your lorebook"></textarea>
                        <div class="help-text">What is your lorebook about? This helps others discover it.</div>
                    </div>

                    <div class="form-group">
                        <label for="lorebook-tags-input">Tags (Optional):</label>
                        <div class="key-input-group">
                            <input type="text" id="lorebook-tags-input" class="key-input" placeholder="Add tag and press Enter">
                            <button id="add-lorebook-tag-button" class="add-key-button">Add</button>
                        </div>
                        <div id="lorebookTagsContainer" class="card-tags" style="margin-top: 10px;"></div>
                        <div class="help-text">Keywords that categorize your lorebook (e.g., Fantasy, Sci-Fi, Character).</div>
                    </div>
                    
                    <div class="toggle-container">
                        <div class="toggle-label">Make this lorebook public:</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="public-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="help-text" style="margin-left: 10px;">Public lorebooks can be viewed and used by everyone. Note: Public lorebooks cannot be deleted with the code once published.</div>
                    </div>
                </div>
                
                <!-- Creator Main Section -->
                <div class="panel-container">
                    <!-- Left Panel - Entry List and Actions -->
                    <div class="panel-left">
                        <div class="creator-card">
                            <div class="section-header">
                                <i class="fa fa-list"></i>
                                <h3>Entries</h3>
                            </div>
                            
                            <div id="entry-list" class="entry-list">
                                <!-- Entries will be added here -->
                                <div class="empty-state">
                                    <i class="fa fa-file-text-o"></i>
                                    <p>No entries yet. Create your first entry!</p>
                                </div>
                            </div>
                            
                            <button id="new-entry-button" class="success-button"><i class="fa fa-plus"></i> New Entry</button>
                        </div>
                        
                        <div class="creator-card">
                            <div class="section-header">
                                <i class="fa fa-cogs"></i>
                                <h3>Lorebook Actions</h3>
                            </div>
                            
                            <div class="button-group">
                                <button id="save-lorebook-button" class="success-button">
                                    <i class="fa fa-download"></i> Download JSON
                                </button>
                                
                                <div class="file-input-container">
                                    <button class="secondary-button">
                                        <i class="fa fa-upload"></i> Load JSON
                                    </button>
                                    <input type="file" id="load-lorebook-file" class="file-input" accept=".json">
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button id="upload-to-proxy-button" class="primary-button">
                                    <i class="fa fa-cloud-upload"></i> Upload to Proxy
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Panel - Entry Editor -->
                    <div class="panel-right">
                        <div class="creator-card">
                            <div class="section-header">
                                <i class="fa fa-edit"></i>
                                <h3>Entry Editor</h3>
                            </div>
                            
                            <div id="entry-editor">
                                <div class="form-group">
                                    <label for="entry-name">Entry Name:</label>
                                    <input type="text" id="entry-name" placeholder="Name this entry">
                                    <div class="help-text">A descriptive name for this entry (for your reference)</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="keyword-input">Primary Keywords:</label>
                                    <div class="key-input-group">
                                        <input type="text" id="keyword-input" class="key-input" placeholder="Add keyword and press Enter">
                                        <button id="add-keyword-button" class="add-key-button">Add</button>
                                    </div>
                                    <div id="keywordTags"></div>
                                    <div class="help-text">Keywords that will trigger this entry</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="secondary-keyword-input">Secondary Keywords (Optional):</label>
                                    <div class="key-input-group">
                                        <input type="text" id="secondary-keyword-input" class="key-input" placeholder="Add secondary keyword">
                                        <button id="add-secondary-keyword-button" class="add-key-button">Add</button>
                                    </div>
                                    <div id="secondaryKeywordTags"></div>
                                    <div class="help-text">Additional keywords with lower priority</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="entry-content">Content:</label>
                                    <textarea id="entry-content" class="creator-textarea" placeholder="Write the content that will be inserted when this entry is triggered"></textarea>
                                    <div class="help-text">The main content that will be injected into the AI context</div>
                                </div>
                                
                                <div class="toggle-container">
                                    <div class="toggle-label">Always Active:</div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="always-active-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div class="help-text" style="margin-left: 10px;">Always include this entry, regardless of keywords</div>
                                </div>
                                
                                <div class="toggle-container">
                                    <div class="toggle-label">Disabled:</div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="disabled-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div class="help-text" style="margin-left: 10px;">Temporarily disable this entry without deleting it</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="entry-order">Priority (Order):</label>
                                    <input type="range" id="entry-order" min="0" max="400" value="100" step="10">
                                    <div class="help-text">Lower numbers have higher priority (100 is default)</div>
                                </div>
                                
                                <div class="button-group">
                                    <button id="save-entry-button" class="success-button">
                                        <i class="fa fa-save"></i> Save Entry
                                    </button>
                                    <button id="delete-entry-button" class="error-button">
                                        <i class="fa fa-trash"></i> Delete Entry
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="creator-card">
                            <div class="section-header">
                                <i class="fa fa-eye"></i>
                                <h3>JSON Preview</h3>
                            </div>
                            <div id="json-preview" class="json-preview">
                                {
  "entries": {},
  "meta": {
    "name": "My Lorebook",
    "description": ""
  }
}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Help Page -->
        <div id="help-page" class="main-content" style="display: none;">
            <h2>How to Use Lorebooks</h2>
            
            <div class="info-box">
                <h3>What is a Lorebook?</h3>
                <p>A Lorebook is a collection of information or "lore" that is automatically injected into your conversations with AI when certain keywords are detected. This helps maintain consistency in your roleplays, stories, or technical discussions.</p>
            </div>
            
            <h3>Creating a Lorebook</h3>
            <ol>
                <li><strong>Go to the Creator page</strong> - Click on "Creator" in the navigation bar.</li>
                <li><strong>Set basic information</strong> - Give your lorebook a name and description.</li>
                <li><strong>Add entries</strong> - Each entry contains keywords that trigger it and content that gets injected.</li>
                <li><strong>Configure settings</strong> - Set priorities, decide if entries should always be active, etc.</li>
                <li><strong>Save your lorebook</strong> - Download it as a JSON file or upload it directly to the proxy.</li>
            </ol>
            
            <h3>Using a Lorebook</h3>
            <ol>
                <li><strong>Upload your lorebook</strong> - Use the "Upload to Proxy" button in the Creator, or browser for public lorebooks.</li>
                <li><strong>Get your lorebook code</strong> - After uploading, you'll receive a unique code (e.g., <code>LORE:ABC123</code>).</li>
                <li><strong>Use in conversations</strong> - Include the code anywhere in your message to the AI.</li>
                <li><strong>Activate entries</strong> - Use keywords from your lorebook in your messages to trigger the corresponding entries.</li>
            </ol>

            <h3>Important Note on Usage</h3>
            <p>Currently, JanitorAI does not natively support lorebooks. Therefore, to use the lorebooks created or found here, you <strong>must</strong> route your AI requests through one of the provided proxy server endpoints (see "Proxy Server" page) or use one of the linked Colab notebooks. These proxy services handle the injection of lorebook entries based on your prompts.</p>
            
            <h3>Lorebook Entry Settings</h3>
            <ul>
                <li><strong>Primary Keywords</strong> - Main trigger words for the entry</li>
                <li><strong>Secondary Keywords</strong> - Additional triggers with lower priority</li>
                <li><strong>Always Active</strong> - Entry is always included, regardless of keywords</li>
                <li><strong>Disabled</strong> - Temporarily disable an entry without deleting it</li>
                <li><strong>Priority</strong> - Lower numbers have higher priority when multiple entries match</li>
            </ul>
            
            <h3>Public vs. Private Lorebooks</h3>
            <p>You can choose to make your lorebook public, allowing others to discover and use it. Public lorebooks are listed on the home page.</p>
            <p><strong>Important:</strong> Once a lorebook is made public, it cannot be deleted using just the code. If you need to remove a public lorebook, please contact: <strong>sophiamccarty_official</strong> on Discord.</p>
        </div>

        <!-- Admin Page -->
        <div id="admin-page" class="main-content" style="display: none;">
            <h2>Admin - All Lorebooks</h2>
            <div class="search-container">
                <input type="search" id="admin-lorebook-search" placeholder="Search all lorebooks..." style="width: 100%; margin-bottom: 15px;">
            </div> <!-- Closing search-container -->
                    <div id="admin-lorebook-list">
                <!-- Lorebooks will be listed here -->
                <div class="empty-state">
                    <p>No lorebooks found or an error occurred.</p>
                </div>
            </div>
        </div> <!-- Closing admin-page -->

        <!-- Proxy Info Page (MOVED HERE) -->
        <div id="proxy-info-page" class="main-content" style="display: none;">
            <h2>Proxy Server Details</h2>
            <p>This page provides details on how to use the proxy server with different AI model providers.</p>
        
            <div class="info-box">
                <h3><i class="fa fa-cogs"></i> Google AI Studio Models</h3>
                <p>To use models via Google AI Studio, configure your application (e.g., JanitorAI) with the following API endpoint:</p>
                <div class="code-display-block">
                    <span id="aistudio-url">https://sophiasunblocker.onrender.com/aistudio</span>
                    <button class="button copy-button" onclick="copyToClipboard('aistudio-url')"><i class="fa fa-copy"></i> Copy URL</button>
                </div>
                <p>Select one of the following models in your application's settings. The proxy will then route your requests to the appropriate Google AI model.</p>
                <h4>Available Models:</h4>
                <ul>
                    <li>gemini-2.5-pro-preview-05-06</li>
                    <li>gemini-2.5-pro-exp-03-25</li>
                    <li>gemini-2.5-flash-preview-04-17</li>
                    <li>gemini-2.0-flash</li>
                    <li>gemini-2.0-flash-lite</li>
                    <li>gemini-2.0-flash-live-001</li>
                    <li>gemini-1.5-pro</li>
                </ul>
            </div>
        
            <div class="info-box">
                <h3><i class="fa fa-rocket"></i> OpenRouter Models</h3>
                <p>To use models via OpenRouter, configure your application with the following API endpoint:</p>
                <div class="code-display-block">
                    <span id="openrouter-url">https://sophiasunblocker.onrender.com/openrouter</span>
                    <button class="button copy-button" onclick="copyToClipboard('openrouter-url')"><i class="fa fa-copy"></i> Copy URL</button>
                </div>

                <div class="alert alert-info" style="margin-top: 15px; padding: 15px;">
                    <h4 style="margin-top: 0; color: var(--primary-dark);"><i class="fa fa-star"></i> Important OpenRouter Feature</h4>
                    <p>Using the OpenRouter endpoint (<code>https://sophiasunblocker.onrender.com/openrouter</code>) allows you to use <strong>any model available on OpenRouter</strong> with your Lorebooks! This includes models like Claude, DeepSeek, Llama, and many more, not just Gemini models.</p>
                    <p>Simply select your desired model in your JanitorAI settings when using this proxy URL.</p>
                </div>

                <p>You can select any model available on OpenRouter. Specify the model string in your application (e.g., JanitorAI settings). The proxy will pass this model identifier to OpenRouter.</p>
                <h4>Example Models (check OpenRouter for the full list and latest identifiers):</h4>
                <ul>
                    <li>google/gemini-2.5-pro-preview</li>
                    <li>google/gemini-2.5-pro-exp-03-25</li>
                    <li>google/gemini-2.5-flash-preview</li>
                    <li>google/gemini-2.0-flash</li>
                    <li>google/gemini-2.0-flash-lite</li>
                    <li>google/gemini-2.0-flash-exp</li>
                    <li>google/gemini-2.0-flash-preview-image</li>
                    <li>google/gemini-2.0-flash-live</li>
                    <li>google/gemini-pro-1.5</li>
                </ul>
            </div>

            <div class="info-box server-commands-container">
                <div class="collapsible-menu server-commands-menu">
                    <button class="collapsible-header">
                        <h3><i class="fa fa-terminal"></i> Server Commands</h3> <i class="fa fa-chevron-down"></i>
                    </button>
                    <div class="collapsible-content">
                        <p style="margin-top:15px; margin-bottom:15px;">You can use the following commands directly in your prompt field in JanitorAI (or other compatible applications) to control the proxy's behavior for the current request:</p>
                        <dl class="command-list" id="server-command-list-dl">
                            <dt>&lt;JAILBREAK=on&gt;</dt>
                            Activates the jailbreak content for /AiStudio, /NonJailbreak and /OpenRouter requests. Overrides the default non-jailbreak behavior of these routes.

                            <dt>&lt;PREFILL-OFF&gt;</dt>
                            Disables the prefill text for this request.

                            <dt>&lt;CUSTOMPREFILL&gt;your text here&lt;/CUSTOMPREFILL&gt;</dt>
                            Uses your custom prefill text instead of the default prefill.

                            <dt>&lt;OOCINJECTION-OFF&gt;</dt>
                            Disables the standard OOC (Out Of Character) instructions that are normally added to your prompt.

                            <dt>&lt;CUSTOMOOC&gt;your OOC text here&lt;/CUSTOMOOC&gt;</dt>
                            Adds your custom OOC instruction to the AI, in addition to any standard OOC.

                            <dt>&lt;FORCEMARKDOWN&gt;</dt>
                            Makes the proxy check and correct the markdown formatting from Google AI responses. Useful if the AI forgets to use asterisks for actions, etc.

                            <dt>&lt;FORCETHINKING&gt;</dt>
                            Forces the AI to output its thinking process before the actual response. This also uses a special prefill designed to encourage step-by-step thinking.

                            <dt>&lt;AUTOPLOT&gt;</dt>
                            Adds a plot twist instruction to the AI to make the story more interesting and unpredictable.

                            <dt>&lt;AUTOPLOT-CHANCE=1:XX&gt;</dt>
                            Sets the chance for AutoPlot to trigger (e.g., 1:10 for a 1 in 10 chance). Default is 1:15.

                            <dt>&lt;CRAZYMODE&gt;</dt>
                            Instructs the AI to add unpredictable and chaotic elements to the story.

                            <dt>&lt;MEDIEVALMODE&gt;</dt>
                            Sets all content in a medieval setting with period-accurate customs, language, and technology.

                            <dt>&lt;BETTERSPICEMODE&gt;</dt>
                            Adds random spicy events and enhances the description of intimate scenes.

                            <dt>&lt;BETTERSPICE-CHANCE=1:XX&gt;</dt>
                            Sets the chance for Better Spice Mode to trigger (e.g., 1:10 for a 1 in 10 chance). Default is 1:20.

                            <dt>&lt;BYPASS=LEVEL&gt;</dt>
                            <p>Enables content bypassing.
                            
                            <dt>&lt;LORE:CODE&gt;</dt>
                            Activates a specific Lorebook for the current request. Replace CODE with the actual Lorebook code (e.g., &lt;LORE:ABC123XYZ&gt;). This command can be placed anywhere in your prompt.
                        </dl>
                    </div>
                </div>
                <p class="help-text" style="margin-top: 10px;">These commands are processed by the proxy before sending the request to the AI model. They are case-insensitive.</p>
            </div>

        </div> <!-- Closing proxy-info-page -->
    </div> <!-- Closing container -->
    
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div>
                Lorebook System for Google AI Proxy
                <p style="font-size: 0.8em; margin-top: 10px; color: var(--medium-gray);">
                    <strong>Disclaimer:</strong> Your data is not stored or logged by this proxy service.
                    The server is open-source and its code can be reviewed on
                    <a href="https://github.com/Sophiamccarty/GeminiUnblocker" target="_blank" style="color: var(--secondary-color);">GitHub</a>.
                </p>
            </div>
            <div class="footer-links">
                <a href="#" id="footer-privacy">Privacy</a>
                <a href="#" id="footer-terms">Terms</a>
                <a href="#" id="footer-contact">Contact</a>
                <a href="#" id="admin-login-link" style="opacity: 0.1; font-size: 10px;">Admin</a>
            </div>
        </div>
    </footer>
    
    <!-- Admin Password Modal -->
    <div id="admin-password-modal" class="modal-background">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Admin Login</h3>
                <button class="modal-close admin-password-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="admin-password-input">Password:</label>
                    <input type="password" id="admin-password-input" placeholder="Enter admin password">
                </div>
                <div id="admin-login-error" class="alert alert-error" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="secondary-button admin-password-modal-close">Cancel</button>
                <button id="admin-login-submit" class="success-button">Login</button>
            </div>
        </div>
    </div>

    <!-- Upload JSON Modal -->
    <div id="upload-modal" class="modal-background">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Upload Lorebook to Proxy</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Upload your lorebook directly to the proxy server. You'll receive a unique code that you can use to activate your lorebook in conversations.</p>
                
                <div id="upload-json-preview" class="json-preview" style="margin: 15px 0; max-height: 150px;"></div>
                
                <div class="toggle-container">
                    <div class="toggle-label">Make this lorebook public:</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="modal-public-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <p class="help-text"><strong>Note:</strong> Public lorebooks can be viewed and used by everyone. They cannot be deleted with the code once published.</p>
            </div>
            <div class="modal-footer">
                <button class="secondary-button modal-cancel-button">Cancel</button>
                <button class="success-button modal-upload-button">Upload to Proxy</button>
            </div>
        </div>
    </div>
    
    <!-- Used Lorebook Modal -->
    <div id="used-lorebook-modal" class="modal-background">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Lorebook Activated Successfully</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>The lorebook has been successfully activated for your next conversations.</p>
                <div class="alert alert-success" style="margin-top: 15px;">
                    <p>Your lorebook code is: <span id="used-lorebook-code" class="code-display"></span></p>
                    <p>To use it, include this command in your prompt or summary (e.g., in JanitorAI or other platforms).</p>
                </div>
                <div class="alert alert-info" style="margin-top: 15px;">
                    <strong>Note for Colab Users:</strong> The codes mentioned above only work directly in prompts on servers that support this system. If you are using Colab or another environment that does not support direct code embedding, please download the JSON file and upload it to your target application.
                </div>
            </div>
            <div class="modal-footer">
                <button id="download-lorebook-json-button" class="button secondary-button"><i class="fa fa-download"></i> Download JSON</button>
                <button class="success-button modal-close-button">Close</button>
            </div>
        </div>
    </div>

    <!-- Font Awesome for icons -->
<!-- Modal for Lorebook Details -->
    <div id="lorebook-details-modal" class="modal-background">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="details-modal-title">Lorebook Details</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="details-modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Content will be injected here -->
            </div>
            <div class="modal-footer">
                <button class="button modal-close-button">Close</button>
            </div>
        </div>
    </div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <script>
        // DOM Elements
        const homePage = document.getElementById('home-page');
        const creatorPage = document.getElementById('creator-page');
        const helpPage = document.getElementById('help-page');
        const proxyInfoPage = document.getElementById('proxy-info-page'); // Neue Seite
        
        const navHome = document.getElementById('nav-home');
        const navCreator = document.getElementById('nav-creator');
        const navHelp = document.getElementById('nav-help');
        const navProxyInfo = document.getElementById('nav-proxy-info'); // Neuer Nav-Link

        // Admin Page Elements
        const adminPage = document.getElementById('admin-page');
        const adminLoginLink = document.getElementById('admin-login-link');
        const adminPasswordModal = document.getElementById('admin-password-modal');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const adminLoginSubmit = document.getElementById('admin-login-submit');
        const adminPasswordModalCloseButtons = document.querySelectorAll('.admin-password-modal-close');
        const adminLoginError = document.getElementById('admin-login-error');
        const adminLorebookList = document.getElementById('admin-lorebook-list');
        const adminLorebookSearch = document.getElementById('admin-lorebook-search');
        let isAdminLoggedIn = false; // Track admin login state
        
        // Navigation
        function showPage(pageId) {
            [homePage, creatorPage, helpPage, proxyInfoPage, adminPage].forEach(page => { // adminPage auch hier einbeziehen
                if (page) page.style.display = 'none';
            });
            
            const pageToShow = document.getElementById(pageId);
            if (pageToShow) pageToShow.style.display = 'block';
            
            [navHome, navCreator, navHelp, navProxyInfo].forEach(nav => {
                if (nav) nav.classList.remove('active');
            });
            const adminNavLink = document.getElementById('nav-admin'); // Admin-Link separat behandeln
            if (adminNavLink) adminNavLink.classList.remove('active');
            
            switch (pageId) {
                case 'home-page':
                    if (navHome) navHome.classList.add('active');
                    break;
                case 'creator-page':
                    if (navCreator) navCreator.classList.add('active');
                    break;
                case 'help-page':
                    if (navHelp) navHelp.classList.add('active');
                    break;
                case 'proxy-info-page':
                    if (navProxyInfo) navProxyInfo.classList.add('active');
                    break;
                case 'admin-page':
                    if (adminNavLink) adminNavLink.classList.add('active');
                    break;
            }
        }
        
        if (navHome) navHome.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('home-page');
        });
        
        if (navCreator) navCreator.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('creator-page');
        });
        
        if (navHelp) navHelp.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('help-page');
        });

        if (navProxyInfo) navProxyInfo.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('proxy-info-page');
        });

        // Admin page functionality
        function createAdminLorebookItem(lorebook) {
            const item = document.createElement('div');
            item.className = 'card admin-lorebook-item'; // Reuse card style for consistency
            item.style.marginBottom = '15px';
            item.dataset.code = lorebook.code; // Für einfachere Selektion
            item.innerHTML = `
                <div class="card-header">
                    <h4 class="card-title" style="font-size: 18px;">${lorebook.name || 'Unnamed Lorebook'} (<span class="code-display">${lorebook.code}</span>)</h4>
                    <div>
                        <button class="button secondary-button edit-admin-lorebook-button" data-code="${lorebook.code}" style="padding: 6px 10px; font-size: 13px; margin-right: 5px;">
                            <i class="fa fa-edit"></i> Edit
                        </button>
                        <button class="button error-button delete-admin-lorebook-button" data-code="${lorebook.code}" style="padding: 6px 10px; font-size: 13px;">
                            <i class="fa fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                <div class="card-body" style="padding-top: 10px; padding-bottom: 10px;">
                    <p style="font-size: 14px; margin-bottom: 8px;"><strong>Description:</strong> ${lorebook.description || 'N/A'}</p>
                    <p style="font-size: 14px; margin-bottom: 8px;">
                        <strong>Status:</strong> ${lorebook.meta?.public ? '<span class="badge badge-success">Public</span>' : '<span class="badge badge-warning">Private</span>'}
                    </p>
                    <p style="font-size: 14px; margin-bottom: 8px;"><strong>Entries:</strong> ${Object.keys(lorebook.entries || {}).length}</p>
                    <p style="font-size: 14px; margin-bottom: 8px;"><strong>Tags:</strong> ${(lorebook.meta?.tags || []).map(tag => `<span class="tag">${tag}</span>`).join(' ') || 'N/A'}</p>
                    <p style="font-size: 12px; color: #666; margin-bottom: 4px;">Created: ${new Date(lorebook.createdAt).toLocaleString()}</p>
                    <p style="font-size: 12px; color: #666; margin-bottom: 0;">Last Used: ${new Date(lorebook.lastUsed).toLocaleString()}</p>
                </div>
            `;
            item.querySelector('.edit-admin-lorebook-button').addEventListener('click', (event) => {
                const codeToEdit = event.currentTarget.dataset.code;
                loadLorebookForEditing(codeToEdit);
            });
            item.querySelector('.delete-admin-lorebook-button').addEventListener('click', async (event) => {
                const button = event.currentTarget;
                button.disabled = true;
                button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Deleting...';

                if (confirm(`Are you sure you want to delete the lorebook "${lorebook.name || lorebook.code}"? This action cannot be undone.`)) {
                    const token = localStorage.getItem('adminToken');
                    if (!token) {
                        adminLogout();
                        adminLoginLink.click();
                        alert("Admin session expired. Please login again.");
                        button.disabled = false;
                        button.innerHTML = '<i class="fa fa-trash"></i> Delete';
                        return;
                    }
                    try {
                        const response = await fetch(`/api/admin/lorebook/${lorebook.code}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const data = await response.json();

                        if (response.ok && data.success) {
                            alert('Lorebook deleted successfully.');
                            item.remove();
                            const listIsEmpty = adminLorebookList.querySelector('.card') === null;
                            if (listIsEmpty && !adminLorebookList.querySelector('.empty-state')) {
                                adminLorebookList.innerHTML = '<div class="empty-state"><p>No lorebooks found or all have been deleted.</p></div>';
                            }
                        } else {
                             if (response.status === 401) {
                                adminLogout();
                                adminLoginLink.click();
                                alert(`Failed to delete lorebook: ${data.message || 'Session expired. Please login again.'}`);
                             } else {
                                alert(`Failed to delete lorebook: ${data.message || 'Unknown server error'}`);
                             }
                        }
                    } catch (error) {
                        console.error("Error deleting lorebook:", error);
                        alert(`Error deleting lorebook: ${error.message}. Check console.`);
                    } finally {
                        button.disabled = false;
                        button.innerHTML = '<i class="fa fa-trash"></i> Delete';
                    }
                } else {
                    button.disabled = false;
                    button.innerHTML = '<i class="fa fa-trash"></i> Delete';
                }
            });
            return item;
        }

        async function loadAdminLorebooks() {
            console.log("loadAdminLorebooks called. isAdminLoggedIn:", isAdminLoggedIn);
            if (!isAdminLoggedIn) {
                adminLorebookList.innerHTML = '<div class="empty-state"><p>Please login as admin to view lorebooks.</p></div>';
                return;
            }
            
            adminLorebookList.innerHTML = '<div class="spinner"></div><p style="text-align:center;">Loading all lorebooks...</p>';
            const token = localStorage.getItem('adminToken');

            if (!token) {
                console.log("Admin token not found in localStorage.");
                adminLogout();
                adminLoginLink.click();
                adminLorebookList.innerHTML = '<div class="empty-state"><p>Admin token not found. Please login.</p></div>';
                return;
            }
            console.log("Admin token found:", token ? "Yes" : "No");

            try {
                console.log("Fetching /api/admin/lorebooks...");
                const response = await fetch('/api/admin/lorebooks', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                console.log("Response status:", response.status);

                const responseText = await response.text(); // Erst Text lesen für Debugging
                console.log("Response text:", responseText);

                let data;
                try {
                    data = JSON.parse(responseText); // Dann parsen
                } catch (e) {
                    console.error("Failed to parse response JSON:", e);
                    throw new Error("Received invalid data from server.");
                }
                
                console.log("Parsed data:", data);

                if (!response.ok) {
                    let errorMsg = `Failed to fetch lorebooks. Status: ${response.status}`;
                    if (response.status === 401) {
                        console.warn("Admin API returned 401, logging out.");
                        adminLogout();
                        adminLoginLink.click();
                        errorMsg = data.message || 'Session expired or invalid. Please login again.';
                    } else {
                        errorMsg = data.message || errorMsg;
                    }
                    throw new Error(errorMsg);
                }
                
                adminLorebookList.innerHTML = ''; // Clear spinner or previous message

                if (data.success && data.lorebooks) {
                    console.log("Lorebooks data received, count:", data.lorebooks.length);
                    if (data.lorebooks.length === 0) {
                        adminLorebookList.innerHTML = '<div class="empty-state"><p>No lorebooks found in the system.</p></div>';
                    } else {
                        data.lorebooks.forEach(lb => {
                            adminLorebookList.appendChild(createAdminLorebookItem(lb));
                        });
                    }
                } else {
                    console.warn("Could not load lorebooks, server indicated failure or no lorebooks field:", data.message);
                    adminLorebookList.innerHTML = `<div class="empty-state"><p>Could not load lorebooks: ${data.message || 'Unknown error from server or no lorebooks data.'}</p></div>`;
                }
            } catch (error) {
                console.error('Error in loadAdminLorebooks:', error);
                adminLorebookList.innerHTML = `<div class="empty-state"><p>Error loading lorebooks: ${error.message}. Check console for details.</p></div>`;
            }
            // filterAdminLorebooks wird nun am Ende von loadAdminLorebooks aufgerufen,
            // um sicherzustellen, dass es nach dem Setzen des Inhalts von adminLorebookList ausgeführt wird.
            filterAdminLorebooks();
        }

        function filterAdminLorebooks() {
            if (!adminPage.style.display || adminPage.style.display === 'none') return;
            const searchTerm = adminLorebookSearch.value.toLowerCase();
            const items = adminLorebookList.querySelectorAll('.card.admin-lorebook-item'); // Genauerer Selektor
            let visibleCount = 0;

            items.forEach(item => {
                const title = item.querySelector('.card-title').textContent.toLowerCase();
                // Korrekter Selektor für den Code, basierend auf der Struktur in createAdminLorebookItem
                const codeElement = item.querySelector('.code-display');
                const code = codeElement ? codeElement.textContent.toLowerCase().replace('code:','').trim() : '';
                
                const descriptionElement = item.querySelector('.card-body p:first-child'); // Annahme: Beschreibung ist das erste <p>
                const description = descriptionElement ? descriptionElement.textContent.toLowerCase() : '';
                
                const tagsElements = item.querySelectorAll('.card-body .tag');
                const tagsText = Array.from(tagsElements).map(tag => tag.textContent.toLowerCase()).join(' ');

                if (title.includes(searchTerm) || code.includes(searchTerm) || description.includes(searchTerm) || tagsText.includes(searchTerm)) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            let emptyState = adminLorebookList.querySelector('.empty-state');
            
            // Stelle sicher, dass ein emptyState-Div existiert, wenn es benötigt wird.
            if (!emptyState && (items.length === 0 || (items.length > 0 && visibleCount === 0 && searchTerm))) {
                emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                // Füge es am Anfang oder Ende der Liste hinzu, je nach Präferenz. Hier am Ende.
                adminLorebookList.appendChild(emptyState);
            }

            if (emptyState) { // Nur fortfahren, wenn emptyState existiert oder erstellt wurde
                emptyState.style.display = 'none'; // Standardmäßig ausblenden

                if (items.length === 0 && !searchTerm) {
                    // Keine Items von Anfang an UND keine Suche:
                    // Der Text wurde von loadAdminLorebooks gesetzt (z.B. "No lorebooks found." oder spezifischer Fehler).
                    // Stelle sicher, dass dieser Status angezeigt wird.
                    // Wenn emptyState.innerHTML leer ist oder den Default-HTML-Text enthält, setze einen Fallback.
                    const currentEmptyText = emptyState.querySelector('p')?.textContent || emptyState.textContent;
                    if (!currentEmptyText || currentEmptyText.trim() === "" || currentEmptyText.includes("No lorebooks found or an error occurred.")) {
                        emptyState.innerHTML = '<p>No lorebooks found.</p>';
                    }
                    emptyState.style.display = 'block';
                } else if (items.length > 0 && visibleCount === 0 && searchTerm) {
                    // Items vorhanden, aber keines passt zur Suche:
                    emptyState.innerHTML = '<p>No lorebooks match your search.</p>';
                    emptyState.style.display = 'block';
                } else if (items.length === 0 && searchTerm) {
                    // Keine Items von Anfang an UND es wird gesucht (unwahrscheinlich, aber zur Sicherheit):
                    emptyState.innerHTML = '<p>No lorebooks match your search.</p>';
                    emptyState.style.display = 'block';
                }
                // Wenn items.length > 0 und visibleCount > 0, bleibt der emptyState ausgeblendet.
            }
        }
        adminLorebookSearch.addEventListener('input', filterAdminLorebooks);

        async function loadLorebookForEditing(code) {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                adminLogout();
                adminLoginLink.click();
                alert("Admin session expired. Please login again.");
                return;
            }
            try {
                // Da wir alle Lorebook-Daten bereits in `loadAdminLorebooks` laden,
                // könnten wir sie clientseitig filtern, anstatt einen neuen API-Aufruf zu machen.
                // Für Konsistenz und falls die Datenmenge groß wird, ist ein API-Aufruf besser.
                // Hier gehen wir davon aus, dass die Daten bereits im `lorebookManager` (serverseitig) sind
                // und der `/api/lorebook/:code` Endpunkt auch für Admins die vollen Daten liefert.
                // WICHTIG: Der `/api/lorebook/:code` Endpunkt muss so angepasst werden,
                // dass er für Admins IMMER das volle Lorebook zurückgibt, auch private.
                // Dies ist in der server.js bereits berücksichtigt durch `req.session.isAdmin`.

                const response = await fetch(`/api/lorebook/${code}`, {
                     headers: { 'Authorization': `Bearer ${token}` } // Admin Token senden
                });
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(`Failed to load lorebook for editing: ${errData.message || response.statusText}`);
                }
                const data = await response.json();

                if (data.success && data.lorebook) {
                    const lbToEdit = data.lorebook;
                    
                    // Setze den Creator-Tab aktiv
                    showPage('creator-page');
                    navCreator.classList.add('active');
                    navHome.classList.remove('active');
                    navHelp.classList.remove('active');
                    const adminNavLink = document.getElementById('nav-admin');
                    if(adminNavLink) adminNavLink.classList.remove('active');


                    // Lade Daten in den Creator
                    lorebookNameInput.value = lbToEdit.meta?.name || '';
                    lorebookDescInput.value = lbToEdit.meta?.description || '';
                    publicToggle.checked = lbToEdit.meta?.public || false;
                    
                    lorebookTagsList = Array.isArray(lbToEdit.meta?.tags) ? [...lbToEdit.meta.tags] : [];
                    updateLorebookTagDisplay();

                    lorebook.entries = {}; // Reset current entries in creator
                    for (const [id, entry] of Object.entries(lbToEdit.entries)) {
                        lorebook.entries[id] = {
                            ...entry,
                            name: entry.name || entry.comment || `Entry ${id}` // UI 'name' hinzufügen
                        };
                    }
                    
                    // Setze den aktuellen Lorebook-Code für den Upload-Button, um ein Update zu signalisieren
                    uploadToProxyButton.dataset.editingCode = code;
                    uploadToProxyButton.innerHTML = '<i class="fa fa-cloud-upload"></i> Update Lorebook on Proxy';


                    resetEntryForm(); // Formular für Einträge zurücksetzen
                    updateEntryList(); // Eintragsliste aktualisieren
                    updateJsonPreview(); // JSON-Vorschau aktualisieren

                    // Scrolle zum Anfang der Creator-Seite
                    window.scrollTo(0, 0);
                    alert(`Lorebook "${lbToEdit.meta?.name || code}" loaded for editing.`);

                } else {
                    alert(`Could not load lorebook ${code} for editing: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error loading lorebook for editing:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Admin Login Logic

        function adminLogout() {
            localStorage.removeItem('adminToken');
            isAdminLoggedIn = false;
            const adminNavLink = document.getElementById('nav-admin');
            if (adminNavLink) {
                adminNavLink.remove(); // Entferne den Admin-Tab komplett
            }
            const logoutLink = document.getElementById('nav-logout');
            if(logoutLink) logoutLink.remove();

            // Zeige die Homepage oder eine andere Standardseite nach dem Logout
            showPage('home-page');
            // Optional: Benachrichtigung für den User
            // alert('You have been logged out.');
        }

        // Füge einen Logout-Button hinzu, wenn der Admin eingeloggt ist
        function updateAdminNavOnLogin() {
            let adminNavLink = document.getElementById('nav-admin');
            let logoutLink = document.getElementById('nav-logout');
            const navContainer = navHelp.parentNode; // Annahme: navHelp existiert und ist im Container

            if (isAdminLoggedIn) {
                if (!adminNavLink && navContainer) {
                    adminNavLink = document.createElement('a');
                    adminNavLink.href = '#';
                    adminNavLink.id = 'nav-admin';
                    adminNavLink.textContent = 'Admin';
                    navContainer.appendChild(adminNavLink);
                    adminNavLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (isAdminLoggedIn) {
                            showPage('admin-page');
                            loadAdminLorebooks(); // Lade Lorebooks beim Klick auf den Admin-Tab
                        } else {
                            adminLoginLink.click();
                        }
                    });
                }

                if(!logoutLink && navContainer) {
                    logoutLink = document.createElement('a');
                    logoutLink.href = '#';
                    logoutLink.id = 'nav-logout';
                    logoutLink.textContent = 'Logout';
                    logoutLink.style.marginLeft = "10px";
                    logoutLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        adminLogout();
                    });
                    navContainer.appendChild(logoutLink);
                }
            } else {
                if (adminNavLink) adminNavLink.remove();
                if (logoutLink) logoutLink.remove();
            }
        }

        adminLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            adminPasswordModal.style.display = 'flex';
            adminPasswordInput.value = '';
            adminLoginError.style.display = 'none';
            adminPasswordInput.focus();
        });

        adminPasswordModalCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                adminPasswordModal.style.display = 'none';
            });
        });

        adminLoginSubmit.addEventListener('click', async () => {
            const password = adminPasswordInput.value;
            if (!password) {
                adminLoginError.textContent = 'Password cannot be empty.';
                adminLoginError.style.display = 'block';
                return;
            }
            adminLoginError.style.display = 'none';
            adminLoginSubmit.disabled = true; // Verhindere doppelte Klicks
            adminLoginSubmit.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Logging in...';


            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (response.ok && data.success && data.token) {
                    localStorage.setItem('adminToken', data.token); // Token speichern
                    isAdminLoggedIn = true;
                    adminPasswordModal.style.display = 'none';
                    
                    // Dynamisch Admin-Nav-Link hinzufügen/aktivieren
                    let adminNavLink = document.getElementById('nav-admin');
                    if (!adminNavLink) {
                        adminNavLink = document.createElement('a');
                        adminNavLink.href = '#';
                        adminNavLink.id = 'nav-admin';
                        adminNavLink.textContent = 'Admin';
                        
                        const navContainer = navHelp.parentNode;
                        if (navContainer) {
                             navContainer.appendChild(adminNavLink);
                        }

                        adminNavLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            if (isAdminLoggedIn) { // Prüfe erneut, falls Token zwischenzeitlich entfernt wurde
                                showPage('admin-page');
                                loadAdminLorebooks(); // Auch hier laden
                            } else {
                                adminLoginLink.click();
                            }
                        });
                    }
                    
                    // Aktiviere Admin-Tab und deaktiviere andere
                    [navHome, navCreator, navHelp].forEach(nav => nav.classList.remove('active'));
                    if(adminNavLink) adminNavLink.classList.add('active');


                    showPage('admin-page');
                    loadAdminLorebooks();
                } else {
                    adminLoginError.textContent = data.message || 'Login failed. Please try again.';
                    adminLoginError.style.display = 'block';
                    isAdminLoggedIn = false;
                    localStorage.removeItem('adminToken'); // Bei Fehler Token entfernen
                }
            } catch (error) {
                console.error("Admin login error:", error);
                adminLoginError.textContent = 'An error occurred during login. Please check console.';
                adminLoginError.style.display = 'block';
                isAdminLoggedIn = false;
            } finally {
                adminLoginSubmit.disabled = false;
                adminLoginSubmit.innerHTML = 'Login';
            }
        });
        
        // Filter buttons
        const filterButtons = document.querySelectorAll('.filter-button');
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                const sortBy = button.getAttribute('data-filter'); // 'all' (useCount), 'popular' (useCount), 'newest' (createdAt)
                let sortParam = 'useCount';
                if (sortBy === 'newest') {
                    sortParam = 'createdAt';
                }
                // Für 'all' und 'popular' wird 'useCount' verwendet, was der Standard im Backend ist.
                // 'all' zeigt einfach alle an, die Sortierung bleibt beim Backend-Standard (useCount)
                // oder wird explizit gesetzt, falls 'all' eine andere Sortierung bedeuten soll.
                // Hier laden wir für 'all' und 'popular' mit useCount, für 'newest' mit createdAt.
                loadPublicLorebooks(sortParam);
            });
        });
        
        // Search functionality
        const searchInput = document.getElementById('lorebook-search');
        const searchButton = document.getElementById('search-button');
        
        function performSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            const cards = document.querySelectorAll('.card');
            
            cards.forEach(card => {
                const title = card.querySelector('.card-title').textContent.toLowerCase();
                const description = card.querySelector('.card-description').textContent.toLowerCase();
                const tags = Array.from(card.querySelectorAll('.tag')).map(tag => tag.textContent.toLowerCase());
                
                if (
                    title.includes(searchTerm) || 
                    description.includes(searchTerm) || 
                    tags.some(tag => tag.includes(searchTerm))
                ) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        let currentLorebookCodeForModal = null; // Variable für den aktuellen Lorebook-Code im Modal
        
        // Use Lorebook buttons (event delegation for dynamically added cards)
        document.getElementById('lorebook-grid').addEventListener('click', function(event) {
            const useButton = event.target.closest('.use-lorebook-button');
            const detailsButton = event.target.closest('.view-details-button');

            if (useButton) {
                const code = useButton.getAttribute('data-code');
                currentLorebookCodeForModal = code; // Aktuellen Code für Download speichern
                const displayCode = code || "N/A";
                document.getElementById('used-lorebook-code').textContent = `<LORE:${displayCode}>`;
                document.getElementById('used-lorebook-modal').style.display = 'flex';
                
                // Ping server to increment useCount
                fetch(`/api/lorebook/${code}/use`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log(`Use count for ${code} incremented.`);
                            // Optional: Update UI if needed, e.g., refresh popular list if currently viewed
                        } else {
                            console.warn(`Could not increment use count for ${code}: ${data.message}`);
                        }
                    })
                    .catch(error => console.error('Error incrementing use count:', error));

            } else if (detailsButton) {
                const code = detailsButton.getAttribute('data-code');
                currentLorebookCodeForModal = code; // Auch für Details-Modal setzen, falls Download dort auch gewünscht wäre
                showLorebookDetails(code);
            }
        });

        // Download-Button im "Use Lorebook"-Modal
        const downloadJsonButton = document.getElementById('download-lorebook-json-button');
        if (downloadJsonButton) {
            downloadJsonButton.addEventListener('click', async () => {
                if (currentLorebookCodeForModal) {
                    await downloadLorebookAsJson(currentLorebookCodeForModal);
                } else {
                    alert('Error: No Lorebook code found to download.');
                    console.error('Download Error: currentLorebookCodeForModal is not set for "Use Lorebook" modal.');
                }
            });
        }

        async function downloadLorebookAsJson(code) {
            try {
                const response = await fetch(`/api/lorebook/${code}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({})); // Versuche, Fehlerdetails zu parsen
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Failed to fetch lorebook'}`);
                }
                const data = await response.json();

                if (data.success && data.lorebook) {
                    const lorebookToDownload = data.lorebook;
                    // Entferne client-spezifische oder temporäre Daten, falls nötig (hier nicht der Fall)
                    // const { someClientOnlyProperty, ...downloadableLorebook } = lorebookToDownload;

                    const filename = `${lorebookToDownload.meta?.name || code}.json`;
                    const jsonStr = JSON.stringify(lorebookToDownload, null, 2);
                    const blob = new Blob([jsonStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    alert('Could not load lorebook data for download: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error downloading lorebook JSON:', error);
                alert(`Error downloading lorebook: ${error.message}`);
            }
        }
        
        // Function to load and display public lorebooks
        const lorebookGrid = document.getElementById('lorebook-grid');
        
        function createLorebookCard(lorebook) {
            const card = document.createElement('div');
            card.className = 'card';
            // Add categories or tags if available in lorebook.meta
            card.setAttribute('data-category', lorebook.meta?.category || 'general');
            card.setAttribute('data-code', lorebook.code); // Store code for easy access
        
            card.innerHTML = `
                <div class="card-header">
                    <h3 class="card-title">${lorebook.name}</h3>
                    <span class="badge badge-primary">Public</span>
                </div>
                <div class="card-body">
                    <p class="card-description">${lorebook.description || 'No description available.'}</p>
                    ${ (lorebook.tags && lorebook.tags.length > 0) ? `
                    <div class="card-tags">
                        ${lorebook.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    ` : '' }
                </div>
                <div class="card-footer">
                    <span class="code-display">Code: ${lorebook.code}</span>
                    <div class="card-footer-right-group">
                        <div class="card-footer-actions">
                            <button class="button outline-button view-details-button" data-code="${lorebook.code}">
                                <i class="fa fa-eye"></i> View Details
                            </button>
                            <button class="button outline-button use-lorebook-button" data-code="${lorebook.code}">
                                <i class="fa fa-book"></i> Use Lorebook
                            </button>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        async function loadPublicLorebooks(sortBy = 'useCount') { // sortBy Parameter hinzugefügt
            try {
                const response = await fetch(`/api/lorebooks/public?sortBy=${sortBy}`); // sortBy an API übergeben
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                lorebookGrid.innerHTML = ''; // Clear existing static or old cards
                
                if (data.success && data.lorebooks && data.lorebooks.length > 0) {
                    data.lorebooks.forEach(lb => {
                        const card = createLorebookCard(lb);
                        lorebookGrid.appendChild(card);
                    });
                } else {
                    lorebookGrid.innerHTML = '<p class="alert alert-info">No public lorebooks available at the moment.</p>';
                }
            } catch (error) {
                console.error('Error loading public lorebooks:', error);
                lorebookGrid.innerHTML = '<p class="alert alert-error">Could not load public lorebooks. Please try again later.</p>';
            }
        }
        
        // Modal elements for details (Ensure these are declared only once, typically at a higher scope or where first needed)
        // const lorebookDetailsModal = document.getElementById('lorebook-details-modal'); // Already declared or should be moved
        // const detailsModalTitle = document.getElementById('details-modal-title'); // Already declared or should be moved
        // const detailsModalBody = document.getElementById('details-modal-body'); // Already declared or should be moved

        async function showLorebookDetails(code) {
            try {
                const response = await fetch(`/api/lorebook/${code}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.success && data.lorebook) {
                    const lb = data.lorebook;
                    detailsModalTitle.textContent = lb.meta?.name || `Lorebook ${lb.code || code}`; // Use lb.code as fallback
                    
                    let entriesHtml = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>Description:</strong> ${lb.meta?.description || 'N/A'}</p>
                            <div class="ratings-modal" style="margin-top: 10px; display: flex; align-items: center; gap: 15px;">
                                <span><strong>Ratings:</strong></span>
                                <button class="button outline-button rate-button" data-code="${lb.code || code}" data-rating="up" title="Upvote">
                                    <i class="fa fa-thumbs-up"></i> <span id="modal-upvotes-${lb.code || code}">${lb.meta?.upvotes || 0}</span>
                                </button>
                                <button class="button outline-button rate-button" data-code="${lb.code || code}" data-rating="down" title="Downvote">
                                    <i class="fa fa-thumbs-down"></i> <span id="modal-downvotes-${lb.code || code}">${lb.meta?.downvotes || 0}</span>
                                </button>
                            </div>
                        </div>
                        <h4>Entries:</h4>
                    `;
                    
                    if (lb.entries && Object.keys(lb.entries).length > 0) {
                        entriesHtml += '<ul style="list-style-type: none; padding-left: 0;">';
                        for (const [entryId, entry] of Object.entries(lb.entries)) {
                            entriesHtml += `<li style="margin-bottom: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px;">`;
                            // Assuming entry.name was added for UI in creator, if not, fallback to entryId or comment
                            let entryDisplayName = entry.name || entry.comment;
                            if (!entryDisplayName) { // Fallback if name and comment are missing
                                const firstKey = entry.key && entry.key.length > 0 ? entry.key[0] : '';
                                entryDisplayName = firstKey || `Entry ${entryId}`;
                            }
                            entriesHtml += `<strong>${entryDisplayName}</strong> (${entry.constant ? 'Always Active' : 'Keyword-based'}) ${entry.disable ? '<span class="badge badge-warning">Disabled</span>' : ''}<br>`;
                            if (!entry.constant && entry.key && entry.key.length > 0) {
                                entriesHtml += `<em>Keywords:</em> ${entry.key.join(', ')}<br>`;
                            }
                            if (!entry.constant && entry.keysecondary && entry.keysecondary.length > 0) {
                                entriesHtml += `<em>Secondary Keywords:</em> ${entry.keysecondary.join(', ')}<br>`;
                             }
                            entriesHtml += `<div style="white-space: pre-wrap; background-color: #f9f9f9; padding: 5px; border-radius: 3px; margin-top: 5px;">${entry.content}</div>`;
                            entriesHtml += `</li>`;
                        }
                        entriesHtml += '</ul>';
                    } else {
                        entriesHtml += '<p>This lorebook has no entries.</p>';
                    }
                    detailsModalBody.innerHTML = entriesHtml;
                    lorebookDetailsModal.style.display = 'flex';
                } else {
                    alert('Could not load lorebook details: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
        console.error('Error fetching lorebook details:', error);
                alert('Error fetching lorebook details. See console for more info.');
            }
        }

        // Event delegation for "View Details" buttons on the lorebook grid
        // This listener is already attached to lorebookGrid for "Use Lorebook" button,
        // we can add the "View Details" logic to the same delegated event listener.
        // The existing listener is at line 1354. I will modify it.
        
        // Modal elements for details
        const lorebookDetailsModal = document.getElementById('lorebook-details-modal');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsModalBody = document.getElementById('details-modal-body');

        async function showLorebookDetails(code) {
            try {
                const response = await fetch(`/api/lorebook/${code}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.success && data.lorebook) {
                    const lb = data.lorebook;
                    detailsModalTitle.textContent = lb.meta?.name || `Lorebook ${lb.code || code}`; // Use lb.code as fallback
                    
                    let entriesHtml = '<p><strong>Description:</strong> ' + (lb.meta?.description || 'N/A') + '</p>';
                    entriesHtml += '<h4>Entries:</h4>';
                    
                    if (lb.entries && Object.keys(lb.entries).length > 0) {
                        entriesHtml += '<ul style="list-style-type: none; padding-left: 0;">';
                        for (const [entryId, entry] of Object.entries(lb.entries)) {
                            entriesHtml += `<li style="margin-bottom: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px;">`;
                            // Assuming entry.name was added for UI in creator, if not, fallback to entryId
                            entriesHtml += `<strong>${entry.name || entry.comment || `Entry ${entryId}`}</strong> (${entry.constant ? 'Always Active' : 'Keyword-based'}) ${entry.disable ? '<span class="badge badge-warning">Disabled</span>' : ''}<br>`;
                            if (!entry.constant && entry.key && entry.key.length > 0) {
                                entriesHtml += `<em>Keywords:</em> ${entry.key.join(', ')}<br>`;
                            }
                            if (!entry.constant && entry.keysecondary && entry.keysecondary.length > 0) {
                                entriesHtml += `<em>Secondary Keywords:</em> ${entry.keysecondary.join(', ')}<br>`;
                            }
                            entriesHtml += `<div style="white-space: pre-wrap; background-color: #f9f9f9; padding: 5px; border-radius: 3px; margin-top: 5px;">${entry.content}</div>`;
                            entriesHtml += `</li>`;
                        }
                        entriesHtml += '</ul>';
                    } else {
                        entriesHtml += '<p>This lorebook has no entries.</p>';
                    }
                    detailsModalBody.innerHTML = entriesHtml;
                    lorebookDetailsModal.style.display = 'flex';
                } else {
                    alert('Could not load lorebook details: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error fetching lorebook details:', error);
                alert('Error fetching lorebook details. See console for more info.');
            }
        }

        // Event delegation for "View Details" buttons on the lorebook grid
        lorebookGrid.addEventListener('click', function(event) {
            const target = event.target.closest('.view-details-button');
            if (target) {
                const code = target.getAttribute('data-code');
                showLorebookDetails(code);
            }
        });
        
        // Creator functionality
        let lorebook = {
            entries: {},
            meta: {
                name: "My Lorebook",
                description: "",
                tags: [],
                admin: {} // Platzhalter für mögliche zukünftige Admin-spezifische Metadaten
            }
        };
        let currentEntryId = null;
        let keywordsList = [];
        let secondaryKeywordsList = [];
        let lorebookTagsList = []; // Hinzugefügt
        
        // Form elements
        const lorebookNameInput = document.getElementById('lorebook-name');
        const lorebookDescInput = document.getElementById('lorebook-description');
        const publicToggle = document.getElementById('public-toggle');
        
        const entryNameInput = document.getElementById('entry-name');
        const keywordInput = document.getElementById('keyword-input');
        const secondaryKeywordInput = document.getElementById('secondary-keyword-input');
        const lorebookTagsInput = document.getElementById('lorebook-tags-input');
        const addLorebookTagButton = document.getElementById('add-lorebook-tag-button');
        const lorebookTagsContainer = document.getElementById('lorebookTagsContainer');
        const entryContentInput = document.getElementById('entry-content');
        const alwaysActiveToggle = document.getElementById('always-active-toggle');
        const disabledToggle = document.getElementById('disabled-toggle');
        const entryOrderInput = document.getElementById('entry-order');
        
        const keywordTagsContainer = document.getElementById('keywordTags');
        const secondaryKeywordTagsContainer = document.getElementById('secondaryKeywordTags');
        const entryListContainer = document.getElementById('entry-list');
        const jsonPreview = document.getElementById('json-preview');
        
        // Buttons
        const newEntryButton = document.getElementById('new-entry-button');
        const saveEntryButton = document.getElementById('save-entry-button');
        const deleteEntryButton = document.getElementById('delete-entry-button');
        const saveLorebookButton = document.getElementById('save-lorebook-button');
        const loadLorebookFile = document.getElementById('load-lorebook-file');
        const uploadToProxyButton = document.getElementById('upload-to-proxy-button');
        
        // Lorebook metadata changes
        lorebookNameInput.addEventListener('input', () => {
            lorebook.meta.name = lorebookNameInput.value;
            updateJsonPreview();
        });
        
        lorebookDescInput.addEventListener('input', () => {
            lorebook.meta.description = lorebookDescInput.value;
            updateJsonPreview();
        });
        
        // Keyword management
        function addKeyword(input, list, container) {
            const keyword = input.value.trim();
            if (keyword && !list.includes(keyword)) {
                list.push(keyword);
                updateKeywordTags(list, container);
                input.value = '';
            }
        }
        
        function removeKeyword(keyword, list, container) {
            const index = list.indexOf(keyword);
            if (index !== -1) {
                list.splice(index, 1);
                updateKeywordTags(list, container);
            }
        }
        
        function updateKeywordTags(list, container) {
            container.innerHTML = '';
            list.forEach(keyword => {
                const tag = document.createElement('div');
                tag.className = 'key-tag';
                tag.innerHTML = `${keyword} <span class="remove-key">&times;</span>`;
                
                const removeButton = tag.querySelector('.remove-key');
                removeButton.addEventListener('click', () => {
                    removeKeyword(keyword, list, container);
                });
                
                container.appendChild(tag);
            });
        }
        
        // Add keyword buttons
        document.getElementById('add-keyword-button').addEventListener('click', () => {
            addKeyword(keywordInput, keywordsList, keywordTagsContainer);
        });
        
        document.getElementById('add-secondary-keyword-button').addEventListener('click', () => {
            addKeyword(secondaryKeywordInput, secondaryKeywordsList, secondaryKeywordTagsContainer);
        });
        
        // Add keyword on Enter
        keywordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                addKeyword(keywordInput, keywordsList, keywordTagsContainer);
            }
        });
        
        secondaryKeywordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                addKeyword(secondaryKeywordInput, secondaryKeywordsList, secondaryKeywordTagsContainer);
            }
        });

        // Lorebook Tag management
        function updateLorebookTagDisplay() {
            lorebookTagsContainer.innerHTML = '';
            lorebookTagsList.forEach(tagText => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag'; // Wiederverwendung der .tag Klasse für das Aussehen
                tagElement.textContent = tagText;
                const removeButton = document.createElement('span');
                removeButton.className = 'remove-key'; // Wiederverwendung für das Aussehen des Schließen-Buttons
                removeButton.innerHTML = '&times;';
                removeButton.style.marginLeft = '8px'; // Etwas mehr Abstand
                removeButton.style.cursor = 'pointer';
                removeButton.onclick = () => removeLorebookTag(tagText);
                tagElement.appendChild(removeButton);
                lorebookTagsContainer.appendChild(tagElement);
            });
            lorebook.meta.tags = [...lorebookTagsList]; // Synchronisiere mit dem lorebook Objekt
            updateJsonPreview();
        }

        function addLorebookTag() {
            const tagText = lorebookTagsInput.value.trim();
            if (tagText && !lorebookTagsList.includes(tagText)) {
                lorebookTagsList.push(tagText);
                lorebookTagsInput.value = '';
                updateLorebookTagDisplay();
            }
        }

        function removeLorebookTag(tagText) {
            lorebookTagsList = lorebookTagsList.filter(t => t !== tagText);
            updateLorebookTagDisplay();
        }

        addLorebookTagButton.addEventListener('click', addLorebookTag);
        lorebookTagsInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Verhindert Formular-Submit, falls vorhanden
                addLorebookTag();
            }
        });
        
        // Entry management
        function resetEntryForm() {
            entryNameInput.value = '';
            keywordsList = [];
            secondaryKeywordsList = [];
            entryContentInput.value = '';
            alwaysActiveToggle.checked = false;
            disabledToggle.checked = false;
            entryOrderInput.value = 100;
            
            updateKeywordTags(keywordsList, keywordTagsContainer);
            updateKeywordTags(secondaryKeywordsList, secondaryKeywordTagsContainer);
            
            currentEntryId = null;
        }
        
        function selectEntry(entryId) {
            if (entryId === currentEntryId) return;
            
            currentEntryId = entryId;
            const entry = lorebook.entries[entryId];
            
            entryNameInput.value = entry.name || '';
            keywordsList = [...entry.key || []];
            secondaryKeywordsList = [...entry.keysecondary || []];
            entryContentInput.value = entry.content || '';
            alwaysActiveToggle.checked = entry.constant || false;
            disabledToggle.checked = entry.disable || false;
            entryOrderInput.value = entry.order || 100;
            
            updateKeywordTags(keywordsList, keywordTagsContainer);
            updateKeywordTags(secondaryKeywordsList, secondaryKeywordTagsContainer);
            
            // Highlight selected entry in list
            const entryItems = entryListContainer.querySelectorAll('.entry-item');
            entryItems.forEach(item => {
                if (item.getAttribute('data-id') === entryId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        function updateEntryList() {
            entryListContainer.innerHTML = '';
            
            if (Object.keys(lorebook.entries).length === 0) {
                entryListContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-file-text-o"></i>
                        <p>No entries yet. Create your first entry!</p>
                    </div>
                `;
                return;
            }
            
            for (const [id, entry] of Object.entries(lorebook.entries)) {
                const entryItem = document.createElement('div');
                entryItem.className = 'entry-item';
                if (id === currentEntryId) {
                    entryItem.classList.add('active');
                }
                entryItem.setAttribute('data-id', id);
                
                const badges = [];
                if (entry.constant) badges.push(`<span class="badge badge-primary">Always</span>`);
                if (entry.disable) badges.push(`<span class="badge badge-warning">Disabled</span>`);
                
                entryItem.innerHTML = `
                    <div class="entry-item-header">
                        <div class="entry-item-title">${entry.name || `Entry ${id}`}</div>
                        <div>${badges.join(' ')}</div>
                    </div>
                    <div class="entry-item-content">${entry.content?.substring(0, 50) || ''}${entry.content?.length > 50 ? '...' : ''}</div>
                `;
                
                entryItem.addEventListener('click', () => {
                    selectEntry(id);
                });
                
                entryListContainer.appendChild(entryItem);
            }
        }
        
        function saveEntry() {
            if (!entryNameInput.value) {
                alert('Please enter a name for this entry');
                return;
            }
            
            if (keywordsList.length === 0 && !alwaysActiveToggle.checked) {
                alert('Please add at least one keyword or mark the entry as "Always Active"');
                return;
            }
            
            if (!entryContentInput.value) {
                alert('Please enter content for this entry');
                return;
            }
            
            // Create or update entry
            if (currentEntryId === null) {
                // Create new entry
                const newId = Date.now().toString();
                lorebook.entries[newId] = {
                    uid: Object.keys(lorebook.entries).length,
                    name: entryNameInput.value,
                    key: keywordsList,
                    keysecondary: secondaryKeywordsList,
                    content: entryContentInput.value,
                    constant: alwaysActiveToggle.checked,
                    selective: false,
                    order: parseInt(entryOrderInput.value),
                    position: 0,
                    disable: disabledToggle.checked
                };
                currentEntryId = newId;
            } else {
                // Update existing entry
                lorebook.entries[currentEntryId] = {
                    ...lorebook.entries[currentEntryId],
                    name: entryNameInput.value,
                    key: keywordsList,
                    keysecondary: secondaryKeywordsList,
                    content: entryContentInput.value,
                    constant: alwaysActiveToggle.checked,
                    order: parseInt(entryOrderInput.value),
                    disable: disabledToggle.checked
                };
            }
            
            updateEntryList();
            updateJsonPreview();
        }
        
        function deleteEntry() {
            if (!currentEntryId) return;
            
            if (confirm('Are you sure you want to delete this entry?')) {
                delete lorebook.entries[currentEntryId];
                resetEntryForm();
                updateEntryList();
                updateJsonPreview();
            }
        }
        
        function updateJsonPreview() {
            // Create a clean version for export
            const currentMetaForSave = { ...lorebook.meta, tags: Array.isArray(lorebook.meta.tags) ? lorebook.meta.tags : [] };
            const exportLorebook = {
                entries: {},
                meta: currentMetaForSave
            };
            
            for (const [id, entry] of Object.entries(lorebook.entries)) {
                // Create a copy without the 'name' field (for UI only)
                const exportEntry = {...entry};
                if ('name' in exportEntry) {
                    delete exportEntry.name;
                }
                exportLorebook.entries[id] = exportEntry;
            }
            
            jsonPreview.textContent = JSON.stringify(exportLorebook, null, 2);
            
            // Also update the upload modal preview
            document.getElementById('upload-json-preview').textContent = JSON.stringify(exportLorebook, null, 2);
        }
        
        // Event listeners for buttons
        newEntryButton.addEventListener('click', () => {
            resetEntryForm();
            document.querySelectorAll('.entry-item').forEach(item => {
                item.classList.remove('active');
            });
        });
        
        saveEntryButton.addEventListener('click', saveEntry);
        deleteEntryButton.addEventListener('click', deleteEntry);
        
        saveLorebookButton.addEventListener('click', () => {
            if (Object.keys(lorebook.entries).length === 0) {
                alert('Your lorebook is empty. Please add at least one entry.');
                return;
            }
            
            // Create a clean version for export
            const currentMetaForSave = { ...lorebook.meta, tags: Array.isArray(lorebook.meta.tags) ? lorebook.meta.tags : [] };
            const exportLorebook = {
                entries: {},
                meta: currentMetaForSave
            };
            
            for (const [id, entry] of Object.entries(lorebook.entries)) {
                // Create a copy without the 'name' field (for UI only)
                const exportEntry = {...entry};
                if ('name' in exportEntry) {
                    delete exportEntry.name;
                }
                exportLorebook.entries[id] = exportEntry;
            }
            
            // Convert to JSON and download
            const lorebookJson = JSON.stringify(exportLorebook, null, 2);
            const blob = new Blob([lorebookJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${lorebook.meta.name.replace(/\s+/g, '_').toLowerCase() || 'lorebook'}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        loadLorebookFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const loadedLorebook = JSON.parse(event.target.result);
                    
                    if (!loadedLorebook.entries) {
                        throw new Error('Invalid lorebook format: missing entries object');
                    }
                    
                    // Reset current state
                    lorebook = {
                        entries: {},
                        meta: {
                            name: loadedLorebook.meta?.name || 'Imported Lorebook',
                            description: loadedLorebook.meta?.description || '',
                            tags: Array.isArray(loadedLorebook.meta?.tags) ? loadedLorebook.meta.tags : [] // Lade Tags
                        }
                    };
                    
                    lorebookTagsList = [...lorebook.meta.tags]; // Synchronisiere lorebookTagsList
                    updateLorebookTagDisplay(); // Aktualisiere die Anzeige der Tags

                    // Load entries
                    for (const [id, entry] of Object.entries(loadedLorebook.entries)) {
                        // Add name field for UI
                        let name = '';
                        if (entry.comment) {
                            name = entry.comment;
                        } else if (entry.key && entry.key.length > 0) {
                            name = entry.key[0];
                        } else {
                            name = `Entry ${id}`;
                        }
                        
                        lorebook.entries[id] = {
                            ...entry,
                            name
                        };
                    }
                    
                    // Update UI
                    lorebookNameInput.value = lorebook.meta.name;
                    lorebookDescInput.value = lorebook.meta.description;
                    // updateLorebookTagDisplay() wird bereits oben aufgerufen beim Setzen von lorebookTagsList
                    resetEntryForm();
                    updateEntryList();
                    updateJsonPreview();
                    
                    alert(`Lorebook loaded successfully with ${Object.keys(lorebook.entries).length} entries.`);
                } catch (error) {
                    alert(`Error loading lorebook: ${error.message}`);
                }
            };
            reader.readAsText(file);
            
            // Reset the file input
            e.target.value = '';
        });
        
        // Upload to Proxy button and modal
        const uploadModal = document.getElementById('upload-modal');
        const modalCloseButtons = document.querySelectorAll('.modal-close, .modal-cancel-button');
        const modalUploadButton = document.querySelector('.modal-upload-button');
        const modalPublicToggle = document.getElementById('modal-public-toggle');
        
        uploadToProxyButton.addEventListener('click', () => {
            if (Object.keys(lorebook.entries).length === 0) {
                alert('Your lorebook is empty. Please add at least one entry.');
                return;
            }
            
            // Sync the public toggle with the main form
            modalPublicToggle.checked = publicToggle.checked;
            
            // Update the JSON preview in the modal
            updateJsonPreview();
            
            // Show the modal
            uploadModal.style.display = 'flex';
        });
        
        modalCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                // General close for all modals that use this class
                if (uploadModal) uploadModal.style.display = 'none';
                
                const usedLorebookModal = document.getElementById('used-lorebook-modal');
                if (usedLorebookModal) usedLorebookModal.style.display = 'none';
                
                if (lorebookDetailsModal) lorebookDetailsModal.style.display = 'none';
            });
        });
        
        // Ensure the specific close button for used-lorebook-modal still works
        const usedLorebookModalCloseButton = document.querySelector('#used-lorebook-modal .modal-close-button');
        if (usedLorebookModalCloseButton) {
            usedLorebookModalCloseButton.addEventListener('click', () => {
                const usedLorebookModal = document.getElementById('used-lorebook-modal');
                if (usedLorebookModal) usedLorebookModal.style.display = 'none';
            });
        }
         // Ensure the specific close button for details-modal still works
        const detailsModalCloseButton = document.querySelector('#lorebook-details-modal .modal-close-button');
        if (detailsModalCloseButton) {
            detailsModalCloseButton.addEventListener('click', () => {
                if (lorebookDetailsModal) lorebookDetailsModal.style.display = 'none';
            });
        }

        modalUploadButton.addEventListener('click', async () => {
            const isEditing = uploadToProxyButton.dataset.editingCode;
            const codeToUpdate = isEditing || null;

            // Create a clean version for export/update
            const payload = {
                entries: {},
                meta: {
                    ...lorebook.meta, // Nimmt Name, Beschreibung etc. aus dem Creator-Formular
                    public: modalPublicToggle.checked, // Nimmt den Status aus dem Modal
                    tags: [...lorebookTagsList] // Nimmt die aktuellen Tags
                }
            };
            
            for (const [id, entry] of Object.entries(lorebook.entries)) {
                const exportEntry = {...entry};
                delete exportEntry.name; // UI-only 'name' entfernen
                payload.entries[id] = exportEntry;
            }

            // UI Feedback für den Upload-Button
            modalUploadButton.disabled = true;
            modalUploadButton.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${isEditing ? 'Updating...' : 'Uploading...'}`;

            try {
                let response;
                let apiUrl = '/api/lorebook';
                let httpMethod = 'POST';

                if (isEditing) {
                    apiUrl = `/api/admin/lorebook/${codeToUpdate}`;
                    httpMethod = 'PUT';
                }
                
                const token = localStorage.getItem('adminToken'); // Für PUT (Admin) erforderlich

                response = await fetch(apiUrl, {
                    method: httpMethod,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(isEditing && token && { 'Authorization': `Bearer ${token}` }) // Token nur für Admin-Update
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    uploadModal.style.display = 'none';
                    
                    if (isEditing) {
                        alert(`Lorebook ${codeToUpdate} updated successfully!`);
                        // Aktualisiere die Admin-Ansicht, um die Änderungen widerzuspiegeln
                        loadAdminLorebooks();
                        // Optional: Zurück zur Admin-Seite springen
                        showPage('admin-page');
                        const adminNavLink = document.getElementById('nav-admin');
                        if(adminNavLink) adminNavLink.classList.add('active');

                    } else {
                        const displayCode = data.code || "N/A";
                        document.getElementById('used-lorebook-code').textContent = `<LORE:${displayCode}>`;
                        document.getElementById('used-lorebook-modal').style.display = 'flex';
                    }
                    
                    if (modalPublicToggle.checked || (isEditing && payload.meta.public)) {
                        loadPublicLorebooks(); // Öffentliche Liste aktualisieren
                    }
                     // Reset editing state
                    uploadToProxyButton.removeAttribute('data-editing-code');
                    uploadToProxyButton.innerHTML = '<i class="fa fa-cloud-upload"></i> Upload to Proxy';

                } else {
                    if (response.status === 401 && isEditing) {
                        adminLogout();
                        adminLoginLink.click();
                        alert(`Failed to update lorebook: ${data.message || 'Session expired. Please login again.'}`);
                    } else {
                        alert(`Error ${isEditing ? 'updating' : 'uploading'} lorebook: ${data.message || 'Unknown server error'}`);
                    }
                }
            } catch (error) {
                console.error(`Error ${isEditing ? 'updating' : 'uploading'} lorebook:`, error);
                alert(`Error: ${error.message}`);
            } finally {
                modalUploadButton.disabled = false;
                modalUploadButton.innerHTML = isEditing ? 'Update Lorebook on Proxy' : 'Upload to Proxy';
            }
        });
        
        // Initialize the UI
        updateEntryList();
        updateJsonPreview();
        
        function copyToClipboard(elementId) {
            const textToCopy = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('Copied to clipboard: ' + textToCopy);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy text. Please try manually.');
            });
        }

        function setupIndividualCopyButtons() {
            const commandListDL = document.getElementById('server-command-list-dl');
            if (commandListDL) {
                const dtElements = commandListDL.querySelectorAll('dt');
                dtElements.forEach(dt => {
                    // Prevent adding multiple buttons
                    if (dt.querySelector('.individual-copy-button')) {
                        return;
                    }

                    let commandText = dt.textContent.trim();
                    // Explizit HTML-Entitäten für spitze Klammern dekodieren
                    const decodedCommandText = commandText.replace(/</g, '<').replace(/>/g, '>');
                    if (decodedCommandText) {
                        const copyButton = document.createElement('button');
                        copyButton.innerHTML = '<i class="fa fa-copy"></i>'; // Nur Icon für Kompaktheit
                        copyButton.className = 'button outline-button individual-copy-button';
                        copyButton.title = 'Copy command';
                        
                        copyButton.style.marginLeft = '10px';
                        copyButton.style.padding = '3px 8px'; // Etwas mehr Padding für Klickbarkeit
                        copyButton.style.fontSize = '12px';
                        copyButton.style.verticalAlign = 'middle';
                        copyButton.style.lineHeight = '1'; // Verhindert zu hohe Buttons durch Icon

                        copyButton.addEventListener('click', (event) => {
                            event.stopPropagation(); // Verhindert, dass das Klicken des Buttons andere Events auslöst
                            navigator.clipboard.writeText(commandText).then(() => {
                                const originalText = copyButton.innerHTML;
                                copyButton.innerHTML = '<i class="fa fa-check"></i>';
                                copyButton.disabled = true;
                                setTimeout(() => {
                                    copyButton.innerHTML = originalText;
                                    copyButton.disabled = false;
                                }, 1500);
                            }).catch(err => {
                                console.error('Failed to copy command: ', err);
                                alert('Failed to copy command. Please try manually.');
                            });
                        });

                        // Den Text des dt-Elements in ein Span wrappen, um den Button daneben zu platzieren
                        const commandSpan = document.createElement('span');
                        commandSpan.textContent = decodedCommandText; // Befehl in Backticks für Code-Darstellung, textContent verwenden
                        
                        dt.innerHTML = ''; // Leere ursprünglichen Text, innerHTML verwenden, um das Span-Element später hinzuzufügen
                        dt.appendChild(commandSpan);
                        dt.appendChild(copyButton);
                        
                        // Style für dt, um Flexbox-Layout zu ermöglichen
                        dt.style.display = 'flex';
                        dt.style.justifyContent = 'space-between'; // Text links, Button rechts
                        dt.style.alignItems = 'center';
                    }
                });
            }
        }

        // Collapsible menu functionality
        const collapsibles = document.querySelectorAll('.collapsible-header');
        collapsibles.forEach(collapsible => {
            collapsible.addEventListener('click', function() {
                this.classList.toggle('active');
                const content = this.nextElementSibling;
                if (content.style.display === "block") {
                    content.style.display = "none";
                } else {
                    content.style.display = "block";
                    // If this is the server commands menu, set up the copy buttons
                    if (this.parentElement.classList.contains('server-commands-menu') || (this.parentElement.id && this.parentElement.id === 'server-commands-menu-direct-parent-check')) { // Add more specific check if needed
                        setupIndividualCopyButtons();
                    }
                }
            });
        });

        // Initial load
        function checkInitialAdminState() {
            const token = localStorage.getItem('adminToken');
            // Hier könnte man einen stillen Ping an einen Admin-Check-Endpunkt senden, um den Token serverseitig zu validieren.
            // Fürs Erste: Wenn Token da ist, gehen wir davon aus, dass der User eingeloggt sein könnte.
            // Die API-Calls werden den Token validieren und ggf. den Logout erzwingen.
            if (token) {
                isAdminLoggedIn = true;
                updateAdminNavOnLogin(); // Stellt sicher, dass Admin-Tab und Logout-Link angezeigt werden
            } else {
                isAdminLoggedIn = false;
                updateAdminNavOnLogin(); // Stellt sicher, dass Admin-Tab und Logout-Link entfernt werden
            }
        }
        checkInitialAdminState();
        showPage('home-page'); // Show home page by default
        loadPublicLorebooks(); // Load public lorebooks on initial page load
        setupIndividualCopyButtons(); // Initial call to set up buttons if the menu is already open or commands are visible
    </script>
</body>
</html>
