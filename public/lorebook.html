<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorebook System - Google AI Proxy</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #5E81AC; /* Bl√§uliches Grau */
            --primary-dark: #4C6A8D;
            --secondary-color: #88C0D0; /* Helles Blaugr√ºn */
            --accent-color: #BF616A; /* Sanftes Rot */
            --success-color: #A3BE8C; /* Sanftes Gr√ºn */
            --error-color: #BF616A; /* Sanftes Rot (gleich wie Akzent f√ºr Konsistenz) */
            --warning-color: #EBCB8B; /* Sanftes Gelb */
            --light-color: #ECEFF4; /* Sehr helles Grau */
            --medium-gray: #D8DEE9;
            --dark-gray: #4C566A;
            --text-color: #2E3440; /* Dunkles Grau f√ºr Text */
            --background-color: #F8F9FA; /* Heller Hintergrund */
            --border-radius: 6px;
            --box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            --font-main: 'Roboto', sans-serif;
            --font-headings: 'Montserrat', sans-serif;
            --primary-color-rgb: 94, 129, 172; /* Entspricht #5E81AC */
            --dark-gray-rgb: 76, 86, 106; /* Entspricht #4C566A */
        }

        body {
            font-family: var(--font-main);
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1300px; /* Etwas breiter f√ºr modernes Layout */
            margin: 0 auto;
            padding: 25px;
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: var(--box-shadow);
            margin-bottom: 35px; /* Etwas mehr Abstand */
            padding: 15px 0; /* Angepasstes Padding */
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1300px; /* Passend zum .container */
            margin: 0 auto;
            padding: 0 25px; /* Passend zum .container */
        }

        .header h1 {
            margin: 0;
            font-family: var(--font-headings);
            font-size: 26px; /* Etwas gr√∂√üer */
            font-weight: 600;
        }

        .header-nav {
            display: flex;
            gap: 20px; /* Etwas mehr Abstand zwischen Links */
        }

        .header-nav a {
            color: var(--light-color); /* Hellere Farbe f√ºr besseren Kontrast auf dunklem Header */
            text-decoration: none;
            padding: 8px 15px; /* Gr√∂√üeres Padding */
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-weight: 500;
        }

        .header-nav a:hover, .header-nav a.active {
            background-color: var(--primary-dark); /* Dunklerer Hintergrund beim Hover/Aktiv */
            color: white; /* Wei√üer Text f√ºr aktiven Link */
        }

        .main-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 35px; /* Etwas mehr Padding */
            margin-bottom: 35px; /* Etwas mehr Abstand */
        }

        h2 {
            font-family: var(--font-headings);
            color: var(--primary-dark); /* Dunklere Prim√§rfarbe f√ºr bessere Lesbarkeit */
            margin-top: 0;
            margin-bottom: 25px; /* Mehr Abstand nach der √úberschrift */
            border-bottom: 2px solid var(--medium-gray); /* Subtilere Trennlinie */
            padding-bottom: 15px; /* Mehr Padding unter der √úberschrift */
            font-size: 22px; /* Angepasste Gr√∂√üe */
            font-weight: 600;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--medium-gray); /* Etwas st√§rkere Linie */
        }

        .tab {
            padding: 12px 22px; /* Mehr Padding */
            cursor: pointer;
            border: none; /* Keine R√§nder standardm√§√üig */
            border-bottom: 2px solid transparent; /* Platzhalter f√ºr aktiven Zustand */
            margin-bottom: -2px; /* √úberlappt die untere Border des Containers */
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: 600;
            color: var(--primary-color);
        }

        .tab:hover:not(.active) {
            background-color: var(--light-color); /* Heller Hintergrund beim Hover */
            color: var(--primary-dark);
        }

        .tab-content {
            display: none;
            padding: 25px; /* Mehr Padding */
            border: 1px solid var(--medium-gray);
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius); /* Abrundung nur unten */
            background-color: white; /* Sicherstellen, dass der Hintergrund wei√ü ist */
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 10px; /* Mehr Abstand */
            font-weight: 500; /* Etwas leichter */
            color: var(--dark-gray); /* Dunkleres Grau f√ºr Label-Text */
            font-size: 15px;
        }

        input[type="text"],
        input[type="search"],
        textarea {
            width: 100%;
            padding: 12px 15px; /* Mehr Padding */
            border: 1px solid var(--medium-gray); /* Subtilerer Rand */
            border-radius: var(--border-radius);
            font-size: 15px;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-sizing: border-box; /* Wichtig f√ºr konsistente Gr√∂√üen */
            background-color: #fff; /* Sicherstellen, dass der Hintergrund wei√ü ist */
        }

        input[type="text"]:focus,
        input[type="search"]:focus,
        textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb, 94, 129, 172), 0.25); /* RGB-Wert f√ºr primary-color muss hier ggf. angepasst werden */
        }

        textarea {
            min-height: 120px; /* Etwas weniger H√∂he */
            font-family: var(--font-main); /* Gleiche Schriftart wie Rest */
            resize: vertical; /* Nur vertikales Resizing erlauben */
        }

        button, .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 18px; /* Angepasstes Padding */
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none; /* F√ºr .button als Link */
        }

        button:hover, .button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px); /* Leichter Hover-Effekt */
        }
        
        button:active, .button:active {
            transform: translateY(0px); /* Klick-Effekt */
        }

        button i, .button i {
            margin-right: 8px;
            font-size: 1.1em; /* Icons etwas gr√∂√üer */
        }

        .button-group {
            display: flex;
            gap: 12px; /* Etwas mehr Abstand */
            margin-top: 25px; /* Etwas mehr Abstand */
        }

        .success-button {
            background-color: var(--success-color);
        }

        .success-button:hover {
            background-color: #8FB07B; /* Dunklere Variante von --success-color */
        }

        .error-button {
            background-color: var(--error-color);
        }

        .error-button:hover {
            background-color: #AC5259; /* Dunklere Variante von --error-color */
        }

        .secondary-button {
            background-color: var(--secondary-color);
            color: var(--text-color); /* Besserer Kontrast f√ºr helles Blaugr√ºn */
        }

        .secondary-button:hover {
            background-color: #79A8B5; /* Dunklere Variante von --secondary-color */
            color: var(--text-color);
        }

        .outline-button {
            background-color: transparent;
            color: var(--primary-color);
            border: 1.5px solid var(--primary-color); /* Etwas dickerer Rand */
        }

        .outline-button:hover {
            background-color: rgba(var(--primary-color-rgb), 0.1); /* Leichter Hintergrund beim Hover */
            color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .alert {
            padding: 18px 22px; /* Mehr Padding */
            margin-bottom: 25px; /* Mehr Abstand */
            border-radius: var(--border-radius);
            border-width: 1px;
            border-style: solid;
            font-size: 15px;
        }

        .alert-success {
            background-color: #EBF5E9; /* Helleres Gr√ºn */
            color: #3A6839; /* Dunkleres Gr√ºn f√ºr Text */
            border-color: var(--success-color);
        }

        .alert-error {
            background-color: #FBEAEB; /* Helleres Rot */
            color: #7D3C42; /* Dunkleres Rot f√ºr Text */
            border-color: var(--error-color);
        }

        .alert-warning {
            background-color: #FEF8E7; /* Helleres Gelb */
            color: #8A6D3B; /* Dunkleres Gelb f√ºr Text */
            border-color: var(--warning-color);
        }

        .alert-info {
            background-color: #E8F3F6; /* Helleres Blau */
            color: #3E6D7A; /* Dunkleres Blau f√ºr Text */
            border-color: var(--secondary-color);
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--medium-gray); /* Subtilerer Rand */
            padding: 25px; /* Mehr Padding */
            margin-bottom: 25px; /* Mehr Abstand */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: var(--box-shadow); /* Standard-Schatten */
        }

        .card:hover {
            transform: translateY(-3px); /* Etwas st√§rkerer Hover-Effekt */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); /* Angepasster Hover-Schatten */
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Bessere Ausrichtung f√ºr l√§ngere Titel */
            margin-bottom: 18px; /* Mehr Abstand */
            padding-bottom: 12px;
            border-bottom: 1px solid var(--light-color);
        }

        .card-title {
            font-family: var(--font-headings);
            font-size: 20px; /* Gr√∂√üerer Titel */
            font-weight: 600;
            color: var(--primary-dark); /* Dunklere Prim√§rfarbe */
            margin: 0;
        }

        .card-body {
            color: var(--text-color); /* Konsistente Textfarbe */
            font-size: 15px;
        }

        .card-description {
            margin-bottom: 18px; /* Mehr Abstand */
            font-size: 15px; /* Etwas gr√∂√üer */
            line-height: 1.6;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px; /* Mehr Abstand */
            padding-top: 15px;
            border-top: 1px solid var(--light-color);
            font-size: 14px;
            color: var(--dark-gray); /* Dunkleres Grau */
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* Mehr Abstand zwischen Tags */
            margin: 15px 0; /* Mehr vertikaler Abstand */
        }

        .tag {
            background-color: var(--light-color); /* Heller Hintergrund */
            color: var(--primary-dark); /* Dunklere Prim√§rfarbe f√ºr Text */
            padding: 5px 10px; /* Mehr Padding */
            border-radius: var(--border-radius);
            font-size: 13px; /* Etwas gr√∂√üer */
            font-weight: 500;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px; /* Mehr Padding */
            border-radius: var(--border-radius); /* Konsistente Rundung */
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase; /* F√ºr besseren Badge-Look */
            letter-spacing: 0.5px;
        }

        .badge-primary {
            background-color: var(--primary-color); /* Prim√§rfarbe als Hintergrund */
            color: white; /* Wei√üer Text */
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: var(--text-color); /* Dunkler Text auf hellem Gelb */
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .search-container {
            margin-bottom: 35px; /* Mehr Abstand */
            background-color: #fff;
            padding: 25px; /* Mehr Padding */
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .search-form {
            display: flex;
            gap: 12px; /* Mehr Abstand */
        }

        .search-form input[type="search"] {
            flex-grow: 1;
            /* Stile werden von globalen input-Styles geerbt */
        }
        .search-form button.search-button { /* Spezifischer Selektor */
             padding: 10px 18px; /* Konsistent mit anderen Buttons */
        }


        .filter-container {
            display: flex;
            flex-wrap: wrap; /* Umbruch bei vielen Filtern */
            gap: 10px;
            margin: 20px 0 0; /* Nur oberer Margin */
        }

        .filter-button {
            padding: 8px 15px; /* Mehr Padding */
            border-radius: var(--border-radius); /* Konsistente Rundung */
            font-size: 13px;
            background-color: var(--light-color);
            color: var(--dark-gray);
            border: 1px solid transparent; /* Platzhalter f√ºr aktiven Rand */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
        }

        .filter-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-dark);
            font-weight: 600;
        }

        .filter-button:hover:not(.active) {
            background-color: var(--medium-gray);
            color: var(--text-color);
        }

        .lorebook-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .code-display {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; /* Bessere Monospace-Schriftarten */
            background-color: var(--light-color);
            padding: 6px 10px; /* Angepasstes Padding */
            border-radius: var(--border-radius);
            font-size: 13px; /* Etwas kleiner */
            color: var(--accent-color); /* Akzentfarbe f√ºr Code */
            display: inline-block;
            border: 1px solid var(--medium-gray);
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 35px; /* Mehr Abstand */
            gap: 5px; /* Abstand zwischen Buttons */
        }

        .pagination-button {
            padding: 8px 14px; /* Mehr Padding */
            border: 1px solid var(--medium-gray);
            color: var(--primary-color);
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border-radius: var(--border-radius); /* Individuelle Rundung f√ºr jeden Button */
            font-weight: 500;
        }

        .pagination-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-button:hover:not(.active) {
            background-color: var(--light-color);
            border-color: var(--primary-color);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 22px; /* Mehr Abstand */
        }

        .toggle-label {
            margin-right: 12px; /* Mehr Abstand */
            font-size: 15px;
            color: var(--dark-gray);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px; /* Etwas kleiner */
            height: 26px; /* Etwas h√∂her f√ºr besseres Klicken */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--medium-gray); /* Helleres Grau f√ºr inaktiven Zustand */
            transition: .3s ease-in-out;
            border-radius: 26px; /* Vollst√§ndig abgerundet */
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px; /* Gr√∂√üerer Kreis */
            width: 20px;  /* Gr√∂√üerer Kreis */
            left: 3px;   /* Angepasste Position */
            bottom: 3px; /* Angepasste Position */
            background-color: white;
            transition: .3s ease-in-out;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        input:checked + .toggle-slider {
            background-color: var(--success-color); /* Erfolgsfarbe f√ºr aktivierten Toggle */
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px); /* Angepasste Translation */
        }

        .input-with-button {
            display: flex;
        }

        .input-with-button input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none; /* Verhindert doppelte R√§nder */
        }

        .input-with-button button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .json-preview {
            background-color: var(--light-color); /* Hellerer Hintergrund */
            border-radius: var(--border-radius);
            padding: 15px; /* Mehr Padding */
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 13px; /* Etwas gr√∂√üer */
            color: var(--text-color);
            overflow: auto;
            max-height: 350px; /* Etwas mehr H√∂he */
            border: 1px solid var(--medium-gray);
            line-height: 1.5;
        }

        .info-box {
            background-color: var(--light-color); /* Hellerer Hintergrund */
            border-left: 5px solid var(--secondary-color); /* Akzentfarbe f√ºr Rand */
            padding: 20px; /* Mehr Padding */
            margin: 25px 0; /* Mehr Abstand */
            border-radius: var(--border-radius); /* Einheitliche Rundung */
        }

        .info-box h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--primary-dark); /* Dunklere Prim√§rfarbe */
            font-family: var(--font-headings);
            font-size: 18px;
        }
        .info-box p {
            font-size: 15px;
            line-height: 1.6;
        }

        .key-container {
            margin-bottom: 20px; /* Mehr Abstand */
        }

        .key-input-group {
            display: flex;
            gap: 8px; /* Weniger Abstand f√ºr kompaktere Gruppe */
            margin-bottom: 8px;
        }

        .key-input { /* Erbt von globalen input-Styles */
            flex-grow: 1;
        }

        .add-key-button { /* Erbt von globalen Button-Styles */
            padding: 8px 12px; /* Kleinerer Button */
            font-size: 14px;
        }

        .key-tag {
            display: inline-flex;
            align-items: center;
            background-color: var(--secondary-color); /* Sekund√§rfarbe f√ºr Tags */
            color: var(--text-color); /* Dunkler Text f√ºr Kontrast */
            padding: 6px 12px; /* Angepasstes Padding */
            border-radius: 15px; /* St√§rkere Rundung f√ºr Tag-Look */
            font-size: 13px;
            margin: 0 6px 6px 0; /* Angepasster Margin */
            font-weight: 500;
        }

        .key-tag .remove-key {
            margin-left: 8px; /* Mehr Abstand zum Text */
            cursor: pointer;
            color: var(--dark-gray);
            font-weight: bold;
            transition: color 0.2s ease-in-out;
        }

        .key-tag .remove-key:hover {
            color: var(--error-color);
        }

        .help-text {
            font-size: 13px; /* Etwas kleiner */
            color: var(--dark-gray); /* Dunkleres Grau */
            margin-top: 8px; /* Mehr Abstand */
            display: block; /* Sicherstellen, dass es Platz einnimmt */
        }

        .entry-list {
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 25px; /* Mehr Abstand */
            background-color: white;
        }

        .entry-item {
            padding: 12px 18px; /* Mehr Padding */
            border-bottom: 1px solid var(--light-color); /* Hellere Trennlinie */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .entry-item:last-child {
            border-bottom: none;
        }

        .entry-item:hover {
            background-color: var(--light-color); /* Heller Hintergrund beim Hover */
        }

        .entry-item.active {
            background-color: rgba(var(--primary-color-rgb), 0.15); /* Leichter Prim√§rfarben-Hintergrund */
            border-left: 4px solid var(--primary-color); /* St√§rkerer linker Rand */
            padding-left: 14px; /* Ausgleich f√ºr den Rand */
        }

        .entry-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .entry-item-title {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 15px;
        }

        .entry-item-content {
            font-size: 13px; /* Etwas kleiner */
            color: var(--dark-gray);
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%; /* Verhindert √úberlappung mit Badges */
        }

        .empty-state {
            text-align: center;
            padding: 50px 25px; /* Mehr Padding */
            color: var(--dark-gray); /* Dunkleres Grau */
            background-color: var(--light-color);
            border-radius: var(--border-radius);
        }

        .empty-state i {
            font-size: 52px; /* Gr√∂√üeres Icon */
            color: var(--medium-gray); /* Subtilere Farbe */
            margin-bottom: 20px; /* Mehr Abstand */
            display: block;
        }
        .empty-state p {
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 25px; /* Mehr Padding */
        }

        .spinner {
            border: 5px solid rgba(var(--dark-gray-rgb, 76, 86, 106), 0.15); /* RGB f√ºr dark-gray anpassen */
            border-radius: 50%;
            border-top: 5px solid var(--primary-color);
            width: 36px; /* Gr√∂√üerer Spinner */
            height: 36px; /* Gr√∂√üerer Spinner */
            animation: spin 0.8s linear infinite; /* Schnellere Animation */
            margin: 0 auto 18px; /* Mehr Abstand */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer styling */
        .footer {
            background-color: var(--dark-gray); /* Dunkleres Grau f√ºr Footer */
            color: var(--light-color); /* Heller Text */
            padding: 25px 0; /* Mehr Padding */
            margin-top: 50px; /* Mehr Abstand */
            font-size: 14px;
        }

        .footer-container {
            max-width: 1300px; /* Passend zum .container */
            margin: 0 auto;
            padding: 0 25px; /* Passend zum .container */
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Umbruch bei Bedarf */
            gap: 15px;
        }

        .footer-links {
            display: flex;
            gap: 20px; /* Mehr Abstand */
        }

        .footer-links a {
            color: var(--light-color);
            text-decoration: none;
            transition: color 0.2s ease-in-out;
        }

        .footer-links a:hover {
            color: var(--secondary-color); /* Akzentfarbe beim Hover */
            text-decoration: underline;
        }

        /* Creator-specific styles */
        .lorebook-creator {
            max-width: 1100px; /* Etwas breiter */
            margin: 0 auto;
        }

        .panel-container {
            display: flex;
            gap: 25px; /* Mehr Abstand */
            margin-bottom: 20px; /* Mehr Abstand */
        }

        .panel-left {
            flex: 1;
            min-width: 300px; /* Etwas breiter */
        }

        .panel-right {
            flex: 2.5; /* Mehr Platz f√ºr den Editor */
            min-width: 450px; /* Etwas breiter */
        }

        .creator-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px; /* Mehr Padding */
            margin-bottom: 20px; /* Mehr Abstand */
            box-shadow: var(--box-shadow);
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px; /* Mehr Abstand */
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-color);
        }

        .section-header i {
            font-size: 20px;
            color: var(--primary-color);
        }

        .section-header h3 {
            font-family: var(--font-headings);
            font-size: 19px; /* Etwas gr√∂√üer */
            font-weight: 600;
            margin: 0;
            padding: 0;
            margin-left: 12px; /* Mehr Abstand zum Icon */
            color: var(--primary-dark);
        }

        /* .entry-card wird durch .entry-item ersetzt und dessen Stile werden verwendet.
           Falls .entry-card noch separat ben√∂tigt wird, hier anpassen.
           Ich gehe davon aus, dass .entry-item die Funktionalit√§t √ºbernimmt. */
        /* .entry-card { ... } */
        /* .entry-card.selected { ... } */


        .creator-textarea { /* Erbt von globalen textarea-Styles */
            width: 100%;
            min-height: 150px; /* Mehr H√∂he f√ºr Creator */
            margin-bottom: 18px; /* Mehr Abstand */
        }

        #keywordTags, #secondaryKeywordTags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* Mehr Abstand */
            margin-bottom: 15px; /* Mehr Abstand */
        }

        /* Responsive adjustments */
        @media (max-width: 992px) { /* Breiterer Breakpoint f√ºr Panel-Umbruch */
            .panel-container {
                flex-direction: column;
            }
            
            .panel-left, .panel-right {
                width: 100%;
                min-width: unset; /* Min-width aufheben f√ºr kleinere Bildschirme */
            }
        }
        @media (max-width: 768px) {
            .lorebook-grid {
                grid-template-columns: 1fr; /* Einspaltig auf kleineren Ger√§ten */
            }
            .header-container {
                flex-direction: column;
                gap: 15px;
                padding: 10px 20px; /* Weniger Padding im Header auf Mobile */
            }
            .header h1 {
                font-size: 20px; /* Kleinere Schrift im Header */
            }
            .header-nav {
                gap: 8px; /* Weniger Abstand in Navi */
                justify-content: center;
                width: 100%;
                flex-wrap: wrap; /* Umbruch f√ºr Nav-Links */
            }
            .header-nav a {
                padding: 7px 9px; /* Kleineres Padding f√ºr Nav-Links */
                font-size: 13px; /* Kleinere Schrift f√ºr Nav-Links */
            }
            .footer-container {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            .container {
                padding: 15px; /* Weniger Padding im Hauptcontainer */
            }
            .main-content, .creator-card, .search-container {
                padding: 20px; /* Weniger Padding in Content-Bl√∂cken */
            }
            h2 {
                font-size: 20px;
                margin-bottom: 20px;
                padding-bottom: 10px;
            }
            .card {
                padding: 20px;
            }
            .card-title {
                font-size: 18px;
            }
            .button, button {
                padding: 9px 15px;
                font-size: 14px;
            }
            .modal {
                max-width: calc(100% - 30px); /* Modal fast volle Breite mit kleinem Rand */
                max-height: calc(100vh - 30px);
            }
            .modal-header, .modal-body, .modal-footer {
                padding: 15px 20px;
            }
            .modal-title {
                font-size: 18px;
            }
        }


        /* Upload/file input styling */
        .file-input-container {
            position: relative;
            display: inline-block;
            /* Der Button darunter wird gestylt */
        }

        .file-input { /* Das eigentliche Input-Feld ist unsichtbar */
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Modal styles */
        .modal-background {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(var(--dark-gray-rgb), 0.75); /* Dunklerer Hintergrund mit RGB Variable */
            z-index: 1050; /* H√∂herer z-index f√ºr Modals */
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto; /* Scrollen f√ºr den Hintergrund, falls Modal zu gro√ü */
        }

        .modal {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 600px; /* Etwas breiter f√ºr mehr Inhalt */
            max-height: calc(100vh - 40px); /* H√∂he begrenzt durch Viewport mit Padding */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); /* Angepasster Schatten */
            display: flex;
            flex-direction: column;
            margin: auto; /* Zentriert das Modal, wenn der Hintergrund scrollt */
        }

        .modal-header {
            padding: 20px 25px; /* Konsistentes Padding */
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Verhindert Schrumpfen des Headers */
        }

        .modal-title {
            margin: 0;
            font-family: var(--font-headings);
            font-size: 20px;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px; /* Gr√∂√üer f√ºr bessere Klickbarkeit */
            cursor: pointer;
            color: var(--dark-gray);
            transition: color 0.2s ease-in-out, transform 0.2s ease;
            padding: 0; /* Kein extra Padding, da Gr√∂√üe √ºber font-size */
            line-height: 1;
        }
        .modal-close:hover {
            color: var(--accent-color);
            transform: rotate(90deg); /* Leichte Drehung beim Hover */
        }

        .modal-body {
            padding: 25px;
            flex-grow: 1;
            overflow-y: auto; /* Scrollen innerhalb des Modal-Bodys */
            font-size: 15px;
            line-height: 1.65; /* Etwas mehr Zeilenh√∂he */
        }
         .modal-body p {
            margin-top: 0;
            margin-bottom: 18px; /* Mehr Abstand */
        }
        .modal-body .help-text {
            font-size: 13px;
            margin-top: -12px;
            margin-bottom: 18px;
        }


        .modal-footer {
            padding: 20px 25px; /* Konsistentes Padding */
            border-top: 1px solid var(--medium-gray);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background-color: var(--background-color); /* Passend zum Body-Hintergrund */
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            flex-shrink: 0; /* Verhindert Schrumpfen des Footers */
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <h1>üìö Lorebook System - Google AI Proxy</h1>
            <nav class="header-nav">
                <a href="#" class="active" id="nav-home">Home</a>
                <a href="#" id="nav-creator">Creator</a>
                <a href="#" id="nav-help">Help</a>
            </nav>
        </div>
    </header>

    <!-- Main Content Container -->
    <div class="container">
        <!-- Home Page / Public Lorebooks -->
        <div id="home-page" class="main-content">
            <h2>Discover Public Lorebooks</h2>
            
            <div class="search-container">
                <div class="search-form">
                    <input type="search" id="lorebook-search" placeholder="Search by name, keywords, or description...">
                    <button class="search-button" id="search-button"><i class="fa fa-search"></i> Search</button>
                </div>
                
                <div class="filter-container">
                    <button class="filter-button active" data-filter="all">All</button>
                    <button class="filter-button" data-filter="popular">Popular</button>
                    <button class="filter-button" data-filter="new">Newest</button>
                    <button class="filter-button" data-filter="fantasy">Fantasy</button>
                    <button class="filter-button" data-filter="sci-fi">Sci-Fi</button>
                    <button class="filter-button" data-filter="historical">Historical</button>
                </div>
            </div>
            
            <div id="lorebook-grid" class="lorebook-grid">
                <!-- Example lorebook cards -->
                <div class="card" data-category="fantasy popular">
                    <div class="card-header">
                        <h3 class="card-title">Middle Earth Handbook</h3>
                        <span class="badge badge-primary">Fantasy</span>
                    </div>
                    <div class="card-body">
                        <p class="card-description">Comprehensive guide to Tolkien's world including places, characters, and events.</p>
                        <div class="card-tags">
                            <span class="tag">Middle Earth</span>
                            <span class="tag">Tolkien</span>
                            <span class="tag">Lord of the Rings</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="code-display"><code>LORE:TLK421</code></div>
                        <button class="outline-button use-lorebook-button" data-code="TLK421">Use This Lorebook</button>
                    </div>
                </div>
                
                <div class="card" data-category="sci-fi new">
                    <div class="card-header">
                        <h3 class="card-title">Galactic Federation Database</h3>
                        <span class="badge badge-primary">Sci-Fi</span>
                    </div>
                    <div class="card-body">
                        <p class="card-description">Details on alien species, space stations, and interstellar politics.</p>
                        <div class="card-tags">
                            <span class="tag">Space</span>
                            <span class="tag">Aliens</span>
                            <span class="tag">Federation</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="code-display"><code>LORE:SPC789</code></div>
                        <button class="outline-button use-lorebook-button" data-code="SPC789">Use This Lorebook</button>
                    </div>
                </div>
                
                <div class="card" data-category="historical popular">
                    <div class="card-header">
                        <h3 class="card-title">Victorian Era Encyclopedia</h3>
                        <span class="badge badge-primary">Historical</span>
                    </div>
                    <div class="card-body">
                        <p class="card-description">Cultural, social, and historical context of Victorian England.</p>
                        <div class="card-tags">
                            <span class="tag">Victorian</span>
                            <span class="tag">19th Century</span>
                            <span class="tag">London</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="code-display"><code>LORE:VCT123</code></div>
                        <button class="outline-button use-lorebook-button" data-code="VCT123">Use This Lorebook</button>
                    </div>
                </div>
            </div>
            
            <div class="pagination">
                <button class="pagination-button">1</button>
                <button class="pagination-button">2</button>
                <button class="pagination-button">3</button>
                <button class="pagination-button">Next</button>
            </div>
        </div>
        
        <!-- Creator Page -->
        <div id="creator-page" class="main-content" style="display: none;">
            <h2>Lorebook Creator</h2>
            
            <div class="lorebook-creator">
                <!-- Creator Metadata -->
                <div class="creator-card">
                    <div class="section-header">
                        <i class="fa fa-book"></i>
                        <h3>Lorebook Information</h3>
                    </div>
                    
                    <div class="form-group">
                        <label for="lorebook-name">Lorebook Name:</label>
                        <input type="text" id="lorebook-name" placeholder="Enter a name for your lorebook">
                        <div class="help-text">A descriptive name for your lorebook</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="lorebook-description">Description:</label>
                        <textarea id="lorebook-description" placeholder="Describe your lorebook"></textarea>
                        <div class="help-text">What is your lorebook about? This helps others discover it.</div>
                    </div>

                    <div class="form-group">
                        <label for="lorebook-tags-input">Tags (Optional):</label>
                        <div class="key-input-group">
                            <input type="text" id="lorebook-tags-input" class="key-input" placeholder="Add tag and press Enter">
                            <button id="add-lorebook-tag-button" class="add-key-button">Add</button>
                        </div>
                        <div id="lorebookTagsContainer" class="card-tags" style="margin-top: 10px;"></div>
                        <div class="help-text">Keywords that categorize your lorebook (e.g., Fantasy, Sci-Fi, Character).</div>
                    </div>
                    
                    <div class="toggle-container">
                        <div class="toggle-label">Make this lorebook public:</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="public-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="help-text" style="margin-left: 10px;">Public lorebooks can be viewed and used by everyone. Note: Public lorebooks cannot be deleted with the code once published.</div>
                    </div>
                </div>
                
                <!-- Creator Main Section -->
                <div class="panel-container">
                    <!-- Left Panel - Entry List and Actions -->
                    <div class="panel-left">
                        <div class="creator-card">
                            <div class="section-header">
                                <i class="fa fa-list"></i>
                                <h3>Entries</h3>
                            </div>
                            
                            <div id="entry-list" class="entry-list">
                                <!-- Entries will be added here -->
                                <div class="empty-state">
                                    <i class="fa fa-file-text-o"></i>
                                    <p>No entries yet. Create your first entry!</p>
                                </div>
                            </div>
                            
                            <button id="new-entry-button" class="success-button"><i class="fa fa-plus"></i> New Entry</button>
                        </div>
                        
                        <div class="creator-card">
                            <div class="section-header">
                                <i class="fa fa-cogs"></i>
                                <h3>Lorebook Actions</h3>
                            </div>
                            
                            <div class="button-group">
                                <button id="save-lorebook-button" class="success-button">
                                    <i class="fa fa-download"></i> Download JSON
                                </button>
                                
                                <div class="file-input-container">
                                    <button class="secondary-button">
                                        <i class="fa fa-upload"></i> Load JSON
                                    </button>
                                    <input type="file" id="load-lorebook-file" class="file-input" accept=".json">
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button id="upload-to-proxy-button" class="primary-button">
                                    <i class="fa fa-cloud-upload"></i> Upload to Proxy
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Panel - Entry Editor -->
                    <div class="panel-right">
                        <div class="creator-card">
                            <div class="section-header">
                                <i class="fa fa-edit"></i>
                                <h3>Entry Editor</h3>
                            </div>
                            
                            <div id="entry-editor">
                                <div class="form-group">
                                    <label for="entry-name">Entry Name:</label>
                                    <input type="text" id="entry-name" placeholder="Name this entry">
                                    <div class="help-text">A descriptive name for this entry (for your reference)</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="keyword-input">Primary Keywords:</label>
                                    <div class="key-input-group">
                                        <input type="text" id="keyword-input" class="key-input" placeholder="Add keyword and press Enter">
                                        <button id="add-keyword-button" class="add-key-button">Add</button>
                                    </div>
                                    <div id="keywordTags"></div>
                                    <div class="help-text">Keywords that will trigger this entry</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="secondary-keyword-input">Secondary Keywords (Optional):</label>
                                    <div class="key-input-group">
                                        <input type="text" id="secondary-keyword-input" class="key-input" placeholder="Add secondary keyword">
                                        <button id="add-secondary-keyword-button" class="add-key-button">Add</button>
                                    </div>
                                    <div id="secondaryKeywordTags"></div>
                                    <div class="help-text">Additional keywords with lower priority</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="entry-content">Content:</label>
                                    <textarea id="entry-content" class="creator-textarea" placeholder="Write the content that will be inserted when this entry is triggered"></textarea>
                                    <div class="help-text">The main content that will be injected into the AI context</div>
                                </div>
                                
                                <div class="toggle-container">
                                    <div class="toggle-label">Always Active:</div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="always-active-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div class="help-text" style="margin-left: 10px;">Always include this entry, regardless of keywords</div>
                                </div>
                                
                                <div class="toggle-container">
                                    <div class="toggle-label">Disabled:</div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="disabled-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div class="help-text" style="margin-left: 10px;">Temporarily disable this entry without deleting it</div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="entry-order">Priority (Order):</label>
                                    <input type="range" id="entry-order" min="0" max="400" value="100" step="10">
                                    <div class="help-text">Lower numbers have higher priority (100 is default)</div>
                                </div>
                                
                                <div class="button-group">
                                    <button id="save-entry-button" class="success-button">
                                        <i class="fa fa-save"></i> Save Entry
                                    </button>
                                    <button id="delete-entry-button" class="error-button">
                                        <i class="fa fa-trash"></i> Delete Entry
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="creator-card">
                            <div class="section-header">
                                <i class="fa fa-eye"></i>
                                <h3>JSON Preview</h3>
                            </div>
                            <div id="json-preview" class="json-preview">
                                {
  "entries": {},
  "meta": {
    "name": "My Lorebook",
    "description": ""
  }
}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Help Page -->
        <div id="help-page" class="main-content" style="display: none;">
            <h2>How to Use Lorebooks</h2>
            
            <div class="info-box">
                <h3>What is a Lorebook?</h3>
                <p>A Lorebook is a collection of information or "lore" that is automatically injected into your conversations with AI when certain keywords are detected. This helps maintain consistency in your roleplays, stories, or technical discussions.</p>
            </div>
            
            <h3>Creating a Lorebook</h3>
            <ol>
                <li><strong>Go to the Creator page</strong> - Click on "Creator" in the navigation bar.</li>
                <li><strong>Set basic information</strong> - Give your lorebook a name and description.</li>
                <li><strong>Add entries</strong> - Each entry contains keywords that trigger it and content that gets injected.</li>
                <li><strong>Configure settings</strong> - Set priorities, decide if entries should always be active, etc.</li>
                <li><strong>Save your lorebook</strong> - Download it as a JSON file or upload it directly to the proxy.</li>
            </ol>
            
            <h3>Using a Lorebook</h3>
            <ol>
                <li><strong>Upload your lorebook</strong> - Use the "Upload to Proxy" button in the Creator, or browser for public lorebooks.</li>
                <li><strong>Get your lorebook code</strong> - After uploading, you'll receive a unique code (e.g., <code>LORE:ABC123</code>).</li>
                <li><strong>Use in conversations</strong> - Include the code anywhere in your message to the AI.</li>
                <li><strong>Activate entries</strong> - Use keywords from your lorebook in your messages to trigger the corresponding entries.</li>
            </ol>
            
            <h3>Lorebook Entry Settings</h3>
            <ul>
                <li><strong>Primary Keywords</strong> - Main trigger words for the entry</li>
                <li><strong>Secondary Keywords</strong> - Additional triggers with lower priority</li>
                <li><strong>Always Active</strong> - Entry is always included, regardless of keywords</li>
                <li><strong>Disabled</strong> - Temporarily disable an entry without deleting it</li>
                <li><strong>Priority</strong> - Lower numbers have higher priority when multiple entries match</li>
            </ul>
            
            <h3>Public vs. Private Lorebooks</h3>
            <p>You can choose to make your lorebook public, allowing others to discover and use it. Public lorebooks are listed on the home page.</p>
            <p><strong>Important:</strong> Once a lorebook is made public, it cannot be deleted using just the code. If you need to remove a public lorebook, please contact: <strong>sophiamccarty_official</strong> on Discord.</p>
        </div>

        <!-- Admin Page -->
        <div id="admin-page" class="main-content" style="display: none;">
            <h2>Admin - All Lorebooks</h2>
            <div class="search-container">
                <input type="search" id="admin-lorebook-search" placeholder="Search all lorebooks..." style="width: 100%; margin-bottom: 15px;">
            </div>
            <div id="admin-lorebook-list">
                <!-- Lorebooks will be listed here -->
                <div class="empty-state">
                    <p>No lorebooks found or an error occurred.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div>Lorebook System for Google AI Proxy</div>
            <div class="footer-links">
                <a href="#" id="footer-privacy">Privacy</a>
                <a href="#" id="footer-terms">Terms</a>
                <a href="#" id="footer-contact">Contact</a>
                <a href="#" id="admin-login-link" style="opacity: 0.1; font-size: 10px;">Admin</a>
            </div>
        </div>
    </footer>
    
    <!-- Admin Password Modal -->
    <div id="admin-password-modal" class="modal-background">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Admin Login</h3>
                <button class="modal-close admin-password-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="admin-password-input">Password:</label>
                    <input type="password" id="admin-password-input" placeholder="Enter admin password">
                </div>
                <div id="admin-login-error" class="alert alert-error" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="secondary-button admin-password-modal-close">Cancel</button>
                <button id="admin-login-submit" class="success-button">Login</button>
            </div>
        </div>
    </div>

    <!-- Upload JSON Modal -->
    <div id="upload-modal" class="modal-background">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Upload Lorebook to Proxy</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Upload your lorebook directly to the proxy server. You'll receive a unique code that you can use to activate your lorebook in conversations.</p>
                
                <div id="upload-json-preview" class="json-preview" style="margin: 15px 0; max-height: 150px;"></div>
                
                <div class="toggle-container">
                    <div class="toggle-label">Make this lorebook public:</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="modal-public-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <p class="help-text"><strong>Note:</strong> Public lorebooks can be viewed and used by everyone. They cannot be deleted with the code once published.</p>
            </div>
            <div class="modal-footer">
                <button class="secondary-button modal-cancel-button">Cancel</button>
                <button class="success-button modal-upload-button">Upload to Proxy</button>
            </div>
        </div>
    </div>
    
    <!-- Used Lorebook Modal -->
    <div id="used-lorebook-modal" class="modal-background">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Lorebook Activated Successfully</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>The lorebook has been successfully activated for your next conversations.</p>
                <div class="alert alert-success" style="margin-top: 15px;">
                    <p>Your lorebook code is: <span id="used-lorebook-code" class="code-display"></span></p>
                    <p>To use it, include this command in your prompt or summary (e.g., in JanitorAI or other platforms).</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="success-button modal-close-button">Close</button>
            </div>
        </div>
    </div>

    <!-- Font Awesome for icons -->
<!-- Modal for Lorebook Details -->
    <div id="lorebook-details-modal" class="modal-background">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="details-modal-title">Lorebook Details</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="details-modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Content will be injected here -->
            </div>
            <div class="modal-footer">
                <button class="button modal-close-button">Close</button>
            </div>
        </div>
    </div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <script>
        // DOM Elements
        const homePage = document.getElementById('home-page');
        const creatorPage = document.getElementById('creator-page');
        const helpPage = document.getElementById('help-page');
        
        const navHome = document.getElementById('nav-home');
        const navCreator = document.getElementById('nav-creator');
        const navHelp = document.getElementById('nav-help');

        // Admin Page Elements
        const adminPage = document.getElementById('admin-page');
        const adminLoginLink = document.getElementById('admin-login-link');
        const adminPasswordModal = document.getElementById('admin-password-modal');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const adminLoginSubmit = document.getElementById('admin-login-submit');
        const adminPasswordModalCloseButtons = document.querySelectorAll('.admin-password-modal-close');
        const adminLoginError = document.getElementById('admin-login-error');
        const adminLorebookList = document.getElementById('admin-lorebook-list');
        const adminLorebookSearch = document.getElementById('admin-lorebook-search');
        let isAdminLoggedIn = false; // Track admin login state
        
        // Navigation
        function showPage(pageId) {
            [homePage, creatorPage, helpPage].forEach(page => {
                page.style.display = 'none';
            });
            
            document.getElementById(pageId).style.display = 'block';
            
            [navHome, navCreator, navHelp].forEach(nav => {
                nav.classList.remove('active');
            });
            
            switch (pageId) {
                case 'home-page':
                    navHome.classList.add('active');
                    break;
                case 'creator-page':
                    navCreator.classList.add('active');
                    break;
                case 'help-page':
                    navHelp.classList.add('active');
                    break;
            }
        }
        
        navHome.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('home-page');
        });
        
        navCreator.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('creator-page');
        });
        
        navHelp.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('help-page');
        });

        // Admin Login Logic

        function adminLogout() {
            localStorage.removeItem('adminToken');
            isAdminLoggedIn = false;
            const adminNavLink = document.getElementById('nav-admin');
            if (adminNavLink) {
                adminNavLink.remove(); // Entferne den Admin-Tab komplett
            }
            const logoutLink = document.getElementById('nav-logout');
            if(logoutLink) logoutLink.remove();

            // Zeige die Homepage oder eine andere Standardseite nach dem Logout
            showPage('home-page');
            // Optional: Benachrichtigung f√ºr den User
            // alert('You have been logged out.');
        }

        // F√ºge einen Logout-Button hinzu, wenn der Admin eingeloggt ist
        function updateAdminNavOnLogin() {
            let adminNavLink = document.getElementById('nav-admin');
            let logoutLink = document.getElementById('nav-logout');
            const navContainer = navHelp.parentNode; // Annahme: navHelp existiert und ist im Container

            if (isAdminLoggedIn) {
                if (!adminNavLink && navContainer) {
                    adminNavLink = document.createElement('a');
                    adminNavLink.href = '#';
                    adminNavLink.id = 'nav-admin';
                    adminNavLink.textContent = 'Admin';
                    navContainer.appendChild(adminNavLink);
                    adminNavLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (isAdminLoggedIn) {
                            showPage('admin-page');
                            loadAdminLorebooks(); // Lade Lorebooks beim Klick auf den Admin-Tab
                        } else {
                            adminLoginLink.click();
                        }
                    });
                }

                if(!logoutLink && navContainer) {
                    logoutLink = document.createElement('a');
                    logoutLink.href = '#';
                    logoutLink.id = 'nav-logout';
                    logoutLink.textContent = 'Logout';
                    logoutLink.style.marginLeft = "10px";
                    logoutLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        adminLogout();
                    });
                    navContainer.appendChild(logoutLink);
                }
            } else {
                if (adminNavLink) adminNavLink.remove();
                if (logoutLink) logoutLink.remove();
            }
        }

        adminLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            adminPasswordModal.style.display = 'flex';
            adminPasswordInput.value = '';
            adminLoginError.style.display = 'none';
            adminPasswordInput.focus();
        });

        adminPasswordModalCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                adminPasswordModal.style.display = 'none';
            });
        });

        adminLoginSubmit.addEventListener('click', async () => {
            const password = adminPasswordInput.value;
            if (!password) {
                adminLoginError.textContent = 'Password cannot be empty.';
                adminLoginError.style.display = 'block';
                return;
            }
            adminLoginError.style.display = 'none';
            adminLoginSubmit.disabled = true; // Verhindere doppelte Klicks
            adminLoginSubmit.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Logging in...';


            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (response.ok && data.success && data.token) {
                    localStorage.setItem('adminToken', data.token); // Token speichern
                    isAdminLoggedIn = true;
                    adminPasswordModal.style.display = 'none';
                    
                    // Dynamisch Admin-Nav-Link hinzuf√ºgen/aktivieren
                    let adminNavLink = document.getElementById('nav-admin');
                    if (!adminNavLink) {
                        adminNavLink = document.createElement('a');
                        adminNavLink.href = '#';
                        adminNavLink.id = 'nav-admin';
                        adminNavLink.textContent = 'Admin';
                        
                        const navContainer = navHelp.parentNode;
                        if (navContainer) {
                             navContainer.appendChild(adminNavLink);
                        }

                        adminNavLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            if (isAdminLoggedIn) { // Pr√ºfe erneut, falls Token zwischenzeitlich entfernt wurde
                                showPage('admin-page');
                                loadAdminLorebooks(); // Auch hier laden
                            } else {
                                adminLoginLink.click();
                            }
                        });
                    }
                    
                    // Aktiviere Admin-Tab und deaktiviere andere
                    [navHome, navCreator, navHelp].forEach(nav => nav.classList.remove('active'));
                    if(adminNavLink) adminNavLink.classList.add('active');


                    showPage('admin-page');
                    loadAdminLorebooks();
                } else {
                    adminLoginError.textContent = data.message || 'Login failed. Please try again.';
                    adminLoginError.style.display = 'block';
                    isAdminLoggedIn = false;
                    localStorage.removeItem('adminToken'); // Bei Fehler Token entfernen
                }
            } catch (error) {
                console.error("Admin login error:", error);
                adminLoginError.textContent = 'An error occurred during login. Please check console.';
                adminLoginError.style.display = 'block';
                isAdminLoggedIn = false;
            } finally {
                adminLoginSubmit.disabled = false;
                adminLoginSubmit.innerHTML = 'Login';
            }
        });
        
        // Filter buttons
        const filterButtons = document.querySelectorAll('.filter-button');
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                const filter = button.getAttribute('data-filter');
                const cards = document.querySelectorAll('.card');
                
                if (filter === 'all') {
                    cards.forEach(card => {
                        card.style.display = 'block';
                    });
                } else {
                    cards.forEach(card => {
                        if (card.getAttribute('data-category').includes(filter)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                }
            });
        });
        
        // Search functionality
        const searchInput = document.getElementById('lorebook-search');
        const searchButton = document.getElementById('search-button');
        
        function performSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            const cards = document.querySelectorAll('.card');
            
            cards.forEach(card => {
                const title = card.querySelector('.card-title').textContent.toLowerCase();
                const description = card.querySelector('.card-description').textContent.toLowerCase();
                const tags = Array.from(card.querySelectorAll('.tag')).map(tag => tag.textContent.toLowerCase());
                
                if (
                    title.includes(searchTerm) || 
                    description.includes(searchTerm) || 
                    tags.some(tag => tag.includes(searchTerm))
                ) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        // Use Lorebook buttons (event delegation for dynamically added cards)
        document.getElementById('lorebook-grid').addEventListener('click', function(event) {
            const useButton = event.target.closest('.use-lorebook-button');
            const detailsButton = event.target.closest('.view-details-button');

            if (useButton) {
                const code = useButton.getAttribute('data-code');
                document.getElementById('used-lorebook-code').innerHTML = `<LORE:${code}>`; // Zeigt <LORE:CODE> an
                document.getElementById('used-lorebook-modal').style.display = 'flex';
                
                // Optional: Ping server to mark as used (if needed for stats, etc.)
                // fetch('/api/use-lorebook/' + code, { method: 'GET' })
                // .catch(error => console.error('Error pinging use-lorebook:', error));
            } else if (detailsButton) {
                const code = detailsButton.getAttribute('data-code');
                showLorebookDetails(code);
            }
        });
        
        // Function to load and display public lorebooks
        const lorebookGrid = document.getElementById('lorebook-grid');
        
        function createLorebookCard(lorebook) {
            const card = document.createElement('div');
            card.className = 'card';
            // Add categories or tags if available in lorebook.meta
            card.setAttribute('data-category', lorebook.meta?.category || 'general');
            card.setAttribute('data-code', lorebook.code); // Store code for easy access
        
            card.innerHTML = `
                <div class="card-header">
                    <h3 class="card-title">${lorebook.name}</h3>
                    <span class="badge badge-primary">Public</span>
                </div>
                <div class="card-body">
                    <p class="card-description">${lorebook.description || 'No description available.'}</p>
                    <div class="card-tags">
                        ${(lorebook.meta?.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                </div>
                <div class="card-footer">
                    <span class="code-display">Code: ${lorebook.code}</span>
                    <div class="ratings" style="margin-left: auto; display: flex; align-items: center; gap: 5px;">
                        <span class="upvotes" title="Upvotes"><i class="fa fa-thumbs-up"></i> ${lorebook.meta?.upvotes || 0}</span>
                        <span class="downvotes" title="Downvotes"><i class="fa fa-thumbs-down"></i> ${lorebook.meta?.downvotes || 0}</span>
                    </div>
                    <div style="margin-left: 10px;">
                        <button class="button outline-button view-details-button" data-code="${lorebook.code}" style="margin-right: 5px;">
                            <i class="fa fa-eye"></i> View Details
                        </button>
                        <button class="button outline-button use-lorebook-button" data-code="${lorebook.code}">
                            <i class="fa fa-book"></i> Use Lorebook
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        async function loadPublicLorebooks() {
            try {
// Modal elements for details
        const lorebookDetailsModal = document.getElementById('lorebook-details-modal');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsModalBody = document.getElementById('details-modal-body');

        async function showLorebookDetails(code) {
            try {
                const response = await fetch(`/api/lorebook/${code}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.success && data.lorebook) {
                    const lb = data.lorebook;
                    detailsModalTitle.textContent = lb.meta?.name || `Lorebook ${lb.code || code}`; // Use lb.code as fallback
                    
                    let entriesHtml = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>Description:</strong> ${lb.meta?.description || 'N/A'}</p>
                            <div class="ratings-modal" style="margin-top: 10px; display: flex; align-items: center; gap: 15px;">
                                <span><strong>Ratings:</strong></span>
                                <button class="button outline-button rate-button" data-code="${lb.code || code}" data-rating="up" title="Upvote">
                                    <i class="fa fa-thumbs-up"></i> <span id="modal-upvotes-${lb.code || code}">${lb.meta?.upvotes || 0}</span>
                                </button>
                                <button class="button outline-button rate-button" data-code="${lb.code || code}" data-rating="down" title="Downvote">
                                    <i class="fa fa-thumbs-down"></i> <span id="modal-downvotes-${lb.code || code}">${lb.meta?.downvotes || 0}</span>
                                </button>
                            </div>
                        </div>
                        <h4>Entries:</h4>
                    `;
                    
                    if (lb.entries && Object.keys(lb.entries).length > 0) {
                        entriesHtml += '<ul style="list-style-type: none; padding-left: 0;">';
                        for (const [entryId, entry] of Object.entries(lb.entries)) {
                            entriesHtml += `<li style="margin-bottom: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px;">`;
                            // Assuming entry.name was added for UI in creator, if not, fallback to entryId or comment
                            let entryDisplayName = entry.name || entry.comment;
                            if (!entryDisplayName) { // Fallback if name and comment are missing
                                const firstKey = entry.key && entry.key.length > 0 ? entry.key[0] : '';
                                entryDisplayName = firstKey || `Entry ${entryId}`;
                            }
                            entriesHtml += `<strong>${entryDisplayName}</strong> (${entry.constant ? 'Always Active' : 'Keyword-based'}) ${entry.disable ? '<span class="badge badge-warning">Disabled</span>' : ''}<br>`;
                            if (!entry.constant && entry.key && entry.key.length > 0) {
                                entriesHtml += `<em>Keywords:</em> ${entry.key.join(', ')}<br>`;
                            }
                            if (!entry.constant && entry.keysecondary && entry.keysecondary.length > 0) {
                                entriesHtml += `<em>Secondary Keywords:</em> ${entry.keysecondary.join(', ')}<br>`;
async function handleRating(code, ratingType) {
            try {
                const response = await fetch(`/api/lorebook/${code}/rate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ratingType: ratingType }),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Unknown error during rating.' }));
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.message}`);
                }

                const data = await response.json();

                if (data.success) {
                    // Update votes in the modal
                    const modalUpvoteElem = document.getElementById(`modal-upvotes-${code}`);
                    const modalDownvoteElem = document.getElementById(`modal-downvotes-${code}`);
                    if (modalUpvoteElem) modalUpvoteElem.textContent = data.upvotes;
                    if (modalDownvoteElem) modalDownvoteElem.textContent = data.downvotes;

                    // Update votes in the card view (if visible)
                    const cardElem = lorebookGrid.querySelector(`.card[data-code="${code}"]`);
                    if (cardElem) {
                        const cardUpvoteElem = cardElem.querySelector('.upvotes');
                        const cardDownvoteElem = cardElem.querySelector('.downvotes');
                        if (cardUpvoteElem) cardUpvoteElem.innerHTML = `<i class="fa fa-thumbs-up"></i> ${data.upvotes}`;
                        if (cardDownvoteElem) cardDownvoteElem.innerHTML = `<i class="fa fa-thumbs-down"></i> ${data.downvotes}`;
                    }
                     // Potentially refresh the public lorebooks if sorting/filtering by rating is implemented later
                    // loadPublicLorebooks(); 
                } else {
                    alert('Failed to submit rating: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error submitting rating:', error);
                alert('Error submitting rating: ' + error.message);
            }
        }

        // Event delegation for rating buttons within the details modal
        detailsModalBody.addEventListener('click', function(event) {
            const target = event.target.closest('.rate-button');
            if (target) {
                const code = target.getAttribute('data-code');
                const ratingType = target.getAttribute('data-rating');
                handleRating(code, ratingType);
            }
        });
                             }
                            entriesHtml += `<div style="white-space: pre-wrap; background-color: #f9f9f9; padding: 5px; border-radius: 3px; margin-top: 5px;">${entry.content}</div>`;
                            entriesHtml += `</li>`;
                        }
                        entriesHtml += '</ul>';
                    } else {
                        entriesHtml += '<p>This lorebook has no entries.</p>';
                    }
                    detailsModalBody.innerHTML = entriesHtml;
                    lorebookDetailsModal.style.display = 'flex';
                } else {
                    alert('Could not load lorebook details: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
// Admin page functionality
        function createAdminLorebookItem(lorebook) {
            const item = document.createElement('div');
            item.className = 'card admin-lorebook-item'; // Reuse card style for consistency
            item.style.marginBottom = '15px';
            item.dataset.code = lorebook.code; // F√ºr einfachere Selektion
            item.innerHTML = `
                <div class="card-header">
                    <h4 class="card-title" style="font-size: 18px;">${lorebook.name || 'Unnamed Lorebook'} (<span class="code-display">${lorebook.code}</span>)</h4>
                    <div>
                        <button class="button secondary-button edit-admin-lorebook-button" data-code="${lorebook.code}" style="padding: 6px 10px; font-size: 13px; margin-right: 5px;">
                            <i class="fa fa-edit"></i> Edit
                        </button>
                        <button class="button error-button delete-admin-lorebook-button" data-code="${lorebook.code}" style="padding: 6px 10px; font-size: 13px;">
                            <i class="fa fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                <div class="card-body" style="padding-top: 10px; padding-bottom: 10px;">
                    <p style="font-size: 14px; margin-bottom: 8px;"><strong>Description:</strong> ${lorebook.description || 'N/A'}</p>
                    <p style="font-size: 14px; margin-bottom: 8px;">
                        <strong>Status:</strong> ${lorebook.meta?.public ? '<span class="badge badge-success">Public</span>' : '<span class="badge badge-warning">Private</span>'}
                    </p>
                    <p style="font-size: 14px; margin-bottom: 8px;"><strong>Entries:</strong> ${Object.keys(lorebook.entries || {}).length}</p>
                    <p style="font-size: 14px; margin-bottom: 8px;"><strong>Tags:</strong> ${(lorebook.meta?.tags || []).map(tag => `<span class="tag">${tag}</span>`).join(' ') || 'N/A'}</p>
                    <p style="font-size: 12px; color: #666; margin-bottom: 4px;">Created: ${new Date(lorebook.createdAt).toLocaleString()}</p>
                    <p style="font-size: 12px; color: #666; margin-bottom: 0;">Last Used: ${new Date(lorebook.lastUsed).toLocaleString()}</p>
                </div>
            `;
            item.querySelector('.edit-admin-lorebook-button').addEventListener('click', (event) => {
                const codeToEdit = event.currentTarget.dataset.code;
                loadLorebookForEditing(codeToEdit);
            });
            item.querySelector('.delete-admin-lorebook-button').addEventListener('click', async (event) => {
                const button = event.currentTarget;
                button.disabled = true;
                button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Deleting...';

                if (confirm(`Are you sure you want to delete the lorebook "${lorebook.name || lorebook.code}"? This action cannot be undone.`)) {
                    const token = localStorage.getItem('adminToken');
                    if (!token) {
                        adminLogout();
                        adminLoginLink.click();
                        alert("Admin session expired. Please login again.");
                        button.disabled = false;
                        button.innerHTML = '<i class="fa fa-trash"></i> Delete';
                        return;
                    }
                    try {
                        const response = await fetch(`/api/admin/lorebook/${lorebook.code}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const data = await response.json();

                        if (response.ok && data.success) {
                            alert('Lorebook deleted successfully.');
                            item.remove();
                            const listIsEmpty = adminLorebookList.querySelector('.card') === null;
                            if (listIsEmpty && !adminLorebookList.querySelector('.empty-state')) {
                                adminLorebookList.innerHTML = '<div class="empty-state"><p>No lorebooks found or all have been deleted.</p></div>';
                            }
                        } else {
                             if (response.status === 401) {
                                adminLogout();
                                adminLoginLink.click();
                                alert(`Failed to delete lorebook: ${data.message || 'Session expired. Please login again.'}`);
                             } else {
                                alert(`Failed to delete lorebook: ${data.message || 'Unknown server error'}`);
                             }
                        }
                    } catch (error) {
                        console.error("Error deleting lorebook:", error);
                        alert(`Error deleting lorebook: ${error.message}. Check console.`);
                    } finally {
                        button.disabled = false;
                        button.innerHTML = '<i class="fa fa-trash"></i> Delete';
                    }
                } else {
                    button.disabled = false;
                    button.innerHTML = '<i class="fa fa-trash"></i> Delete';
                }
            });
            return item;
        }

        async function loadAdminLorebooks() {
            if (!isAdminLoggedIn) return;
            adminLorebookList.innerHTML = '<div class="spinner"></div><p style="text-align:center;">Loading lorebooks...</p>';
            const token = localStorage.getItem('adminToken');
            if (!token) {
                adminLogout(); // Stellt sicher, dass der User ausgeloggt wird, falls kein Token da ist
                adminLoginLink.click(); // Zeige Login Modal
                adminLorebookList.innerHTML = '<div class="empty-state"><p>Admin token not found. Please login.</p></div>';
                return;
            }

            try {
                const response = await fetch('/api/admin/lorebooks', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    let errorMsg = `Failed to fetch lorebooks. Status: ${response.status}`;
                    if (response.status === 401) { // Unautorisiert, Token k√∂nnte abgelaufen/ung√ºltig sein
                        adminLogout();
                        adminLoginLink.click();
                        errorMsg = 'Session expired or invalid. Please login again.';
                    } else {
                        try {
                            const errData = await response.json();
                            errorMsg = errData.message || errorMsg;
                        } catch (e) { /* ignore json parsing error */ }
                    }
                    throw new Error(errorMsg);
                }
                const data = await response.json();
                adminLorebookList.innerHTML = ''; // Clear spinner
                if (data.success && data.lorebooks) {
                    if (data.lorebooks.length === 0) {
                        adminLorebookList.innerHTML = '<div class="empty-state"><p>No lorebooks found.</p></div>';
                        return;
                    }
                    data.lorebooks.forEach(lb => {
                        adminLorebookList.appendChild(createAdminLorebookItem(lb));
                    });
                } else {
                    adminLorebookList.innerHTML = `<div class="empty-state"><p>Could not load lorebooks: ${data.message || 'Unknown error from server'}</p></div>`;
                }
            } catch (error) {
                console.error('Error loading admin lorebooks:', error);
                adminLorebookList.innerHTML = `<div class="empty-state"><p>Error loading lorebooks: ${error.message}. Check console.</p></div>`;
            }
            filterAdminLorebooks();
        }

        function filterAdminLorebooks() {
            if (!adminPage.style.display || adminPage.style.display === 'none') return;
            const searchTerm = adminLorebookSearch.value.toLowerCase();
            const items = adminLorebookList.querySelectorAll('.card.admin-lorebook-item'); // Genauerer Selektor
            let visibleCount = 0;

            items.forEach(item => {
                const title = item.querySelector('.card-title').textContent.toLowerCase();
                // Korrekter Selektor f√ºr den Code, basierend auf der Struktur in createAdminLorebookItem
                const codeElement = item.querySelector('.code-display');
                const code = codeElement ? codeElement.textContent.toLowerCase().replace('code:','').trim() : '';
                
                const descriptionElement = item.querySelector('.card-body p:first-child'); // Annahme: Beschreibung ist das erste <p>
                const description = descriptionElement ? descriptionElement.textContent.toLowerCase() : '';
                
                const tagsElements = item.querySelectorAll('.card-body .tag');
                const tagsText = Array.from(tagsElements).map(tag => tag.textContent.toLowerCase()).join(' ');

                if (title.includes(searchTerm) || code.includes(searchTerm) || description.includes(searchTerm) || tagsText.includes(searchTerm)) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            let emptyState = adminLorebookList.querySelector('.empty-state');
            
            // Stelle sicher, dass ein emptyState-Div existiert, wenn es ben√∂tigt wird.
            if (!emptyState && (items.length === 0 || (items.length > 0 && visibleCount === 0 && searchTerm))) {
                emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                // F√ºge es am Anfang oder Ende der Liste hinzu, je nach Pr√§ferenz. Hier am Ende.
                adminLorebookList.appendChild(emptyState);
            }

            if (emptyState) { // Nur fortfahren, wenn emptyState existiert oder erstellt wurde
                emptyState.style.display = 'none'; // Standardm√§√üig ausblenden

                if (items.length === 0 && !searchTerm) {
                    // Keine Items von Anfang an UND keine Suche:
                    // Der Text wurde von loadAdminLorebooks gesetzt (z.B. "No lorebooks found." oder spezifischer Fehler).
                    // Stelle sicher, dass dieser Status angezeigt wird.
                    // Wenn emptyState.innerHTML leer ist oder den Default-HTML-Text enth√§lt, setze einen Fallback.
                    const currentEmptyText = emptyState.querySelector('p')?.textContent || emptyState.textContent;
                    if (!currentEmptyText || currentEmptyText.trim() === "" || currentEmptyText.includes("No lorebooks found or an error occurred.")) {
                        emptyState.innerHTML = '<p>No lorebooks found.</p>';
                    }
                    emptyState.style.display = 'block';
                } else if (items.length > 0 && visibleCount === 0 && searchTerm) {
                    // Items vorhanden, aber keines passt zur Suche:
                    emptyState.innerHTML = '<p>No lorebooks match your search.</p>';
                    emptyState.style.display = 'block';
                } else if (items.length === 0 && searchTerm) {
                    // Keine Items von Anfang an UND es wird gesucht (unwahrscheinlich, aber zur Sicherheit):
                    emptyState.innerHTML = '<p>No lorebooks match your search.</p>';
                    emptyState.style.display = 'block';
                }
                // Wenn items.length > 0 und visibleCount > 0, bleibt der emptyState ausgeblendet.
            }
        }
        adminLorebookSearch.addEventListener('input', filterAdminLorebooks);

        async function loadLorebookForEditing(code) {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                adminLogout();
                adminLoginLink.click();
                alert("Admin session expired. Please login again.");
                return;
            }
            try {
                // Da wir alle Lorebook-Daten bereits in `loadAdminLorebooks` laden,
                // k√∂nnten wir sie clientseitig filtern, anstatt einen neuen API-Aufruf zu machen.
                // F√ºr Konsistenz und falls die Datenmenge gro√ü wird, ist ein API-Aufruf besser.
                // Hier gehen wir davon aus, dass die Daten bereits im `lorebookManager` (serverseitig) sind
                // und der `/api/lorebook/:code` Endpunkt auch f√ºr Admins die vollen Daten liefert.
                // WICHTIG: Der `/api/lorebook/:code` Endpunkt muss so angepasst werden,
                // dass er f√ºr Admins IMMER das volle Lorebook zur√ºckgibt, auch private.
                // Dies ist in der server.js bereits ber√ºcksichtigt durch `req.session.isAdmin`.

                const response = await fetch(`/api/lorebook/${code}`, {
                     headers: { 'Authorization': `Bearer ${token}` } // Admin Token senden
                });
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(`Failed to load lorebook for editing: ${errData.message || response.statusText}`);
                }
                const data = await response.json();

                if (data.success && data.lorebook) {
                    const lbToEdit = data.lorebook;
                    
                    // Setze den Creator-Tab aktiv
                    showPage('creator-page');
                    navCreator.classList.add('active');
                    navHome.classList.remove('active');
                    navHelp.classList.remove('active');
                    const adminNavLink = document.getElementById('nav-admin');
                    if(adminNavLink) adminNavLink.classList.remove('active');


                    // Lade Daten in den Creator
                    lorebookNameInput.value = lbToEdit.meta?.name || '';
                    lorebookDescInput.value = lbToEdit.meta?.description || '';
                    publicToggle.checked = lbToEdit.meta?.public || false;
                    
                    lorebookTagsList = Array.isArray(lbToEdit.meta?.tags) ? [...lbToEdit.meta.tags] : [];
                    updateLorebookTagDisplay();

                    lorebook.entries = {}; // Reset current entries in creator
                    for (const [id, entry] of Object.entries(lbToEdit.entries)) {
                        lorebook.entries[id] = {
                            ...entry,
                            name: entry.name || entry.comment || `Entry ${id}` // UI 'name' hinzuf√ºgen
                        };
                    }
                    
                    // Setze den aktuellen Lorebook-Code f√ºr den Upload-Button, um ein Update zu signalisieren
                    uploadToProxyButton.dataset.editingCode = code;
                    uploadToProxyButton.innerHTML = '<i class="fa fa-cloud-upload"></i> Update Lorebook on Proxy';


                    resetEntryForm(); // Formular f√ºr Eintr√§ge zur√ºcksetzen
                    updateEntryList(); // Eintragsliste aktualisieren
                    updateJsonPreview(); // JSON-Vorschau aktualisieren

                    // Scrolle zum Anfang der Creator-Seite
                    window.scrollTo(0, 0);
                    alert(`Lorebook "${lbToEdit.meta?.name || code}" loaded for editing.`);

                } else {
                    alert(`Could not load lorebook ${code} for editing: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error loading lorebook for editing:', error);
                alert(`Error: ${error.message}`);
            }
        }


                console.error('Error fetching lorebook details:', error);
                alert('Error fetching lorebook details. See console for more info.');
            }
        }

        // Event delegation for "View Details" buttons on the lorebook grid
        // This listener is already attached to lorebookGrid for "Use Lorebook" button,
        // we can add the "View Details" logic to the same delegated event listener.
        // The existing listener is at line 1354. I will modify it.
                const response = await fetch('/api/lorebooks/public');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                lorebookGrid.innerHTML = ''; // Clear existing static or old cards
                
                if (data.success && data.lorebooks && data.lorebooks.length > 0) {
                    data.lorebooks.forEach(lb => {
                        const card = createLorebookCard(lb);
                        lorebookGrid.appendChild(card);
                    });
                } else {
                    lorebookGrid.innerHTML = '<p class="alert alert-info">No public lorebooks available at the moment.</p>';
                }
            } catch (error) {
                console.error('Error loading public lorebooks:', error);
                lorebookGrid.innerHTML = '<p class="alert alert-error">Could not load public lorebooks. Please try again later.</p>';
            }
        }
        
        // Modal elements for details
        const lorebookDetailsModal = document.getElementById('lorebook-details-modal');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsModalBody = document.getElementById('details-modal-body');

        async function showLorebookDetails(code) {
            try {
                const response = await fetch(`/api/lorebook/${code}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.success && data.lorebook) {
                    const lb = data.lorebook;
                    detailsModalTitle.textContent = lb.meta?.name || `Lorebook ${lb.code || code}`; // Use lb.code as fallback
                    
                    let entriesHtml = '<p><strong>Description:</strong> ' + (lb.meta?.description || 'N/A') + '</p>';
                    entriesHtml += '<h4>Entries:</h4>';
                    
                    if (lb.entries && Object.keys(lb.entries).length > 0) {
                        entriesHtml += '<ul style="list-style-type: none; padding-left: 0;">';
                        for (const [entryId, entry] of Object.entries(lb.entries)) {
                            entriesHtml += `<li style="margin-bottom: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px;">`;
                            // Assuming entry.name was added for UI in creator, if not, fallback to entryId
                            entriesHtml += `<strong>${entry.name || entry.comment || `Entry ${entryId}`}</strong> (${entry.constant ? 'Always Active' : 'Keyword-based'}) ${entry.disable ? '<span class="badge badge-warning">Disabled</span>' : ''}<br>`;
                            if (!entry.constant && entry.key && entry.key.length > 0) {
                                entriesHtml += `<em>Keywords:</em> ${entry.key.join(', ')}<br>`;
                            }
                            if (!entry.constant && entry.keysecondary && entry.keysecondary.length > 0) {
                                entriesHtml += `<em>Secondary Keywords:</em> ${entry.keysecondary.join(', ')}<br>`;
                            }
                            entriesHtml += `<div style="white-space: pre-wrap; background-color: #f9f9f9; padding: 5px; border-radius: 3px; margin-top: 5px;">${entry.content}</div>`;
                            entriesHtml += `</li>`;
                        }
                        entriesHtml += '</ul>';
                    } else {
                        entriesHtml += '<p>This lorebook has no entries.</p>';
                    }
                    detailsModalBody.innerHTML = entriesHtml;
                    lorebookDetailsModal.style.display = 'flex';
                } else {
                    alert('Could not load lorebook details: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error fetching lorebook details:', error);
                alert('Error fetching lorebook details. See console for more info.');
            }
        }

        // Event delegation for "View Details" buttons on the lorebook grid
        lorebookGrid.addEventListener('click', function(event) {
            const target = event.target.closest('.view-details-button');
            if (target) {
                const code = target.getAttribute('data-code');
                showLorebookDetails(code);
            }
        });
        
        // Creator functionality
        let lorebook = {
            entries: {},
            meta: {
                name: "My Lorebook",
                description: "",
                tags: [],
                admin: {} // Platzhalter f√ºr m√∂gliche zuk√ºnftige Admin-spezifische Metadaten
            }
        };
        let currentEntryId = null;
        let keywordsList = [];
        let secondaryKeywordsList = [];
        let lorebookTagsList = []; // Hinzugef√ºgt
        
        // Form elements
        const lorebookNameInput = document.getElementById('lorebook-name');
        const lorebookDescInput = document.getElementById('lorebook-description');
        const publicToggle = document.getElementById('public-toggle');
        
        const entryNameInput = document.getElementById('entry-name');
        const keywordInput = document.getElementById('keyword-input');
        const secondaryKeywordInput = document.getElementById('secondary-keyword-input');
        const lorebookTagsInput = document.getElementById('lorebook-tags-input');
        const addLorebookTagButton = document.getElementById('add-lorebook-tag-button');
        const lorebookTagsContainer = document.getElementById('lorebookTagsContainer');
        const entryContentInput = document.getElementById('entry-content');
        const alwaysActiveToggle = document.getElementById('always-active-toggle');
        const disabledToggle = document.getElementById('disabled-toggle');
        const entryOrderInput = document.getElementById('entry-order');
        
        const keywordTagsContainer = document.getElementById('keywordTags');
        const secondaryKeywordTagsContainer = document.getElementById('secondaryKeywordTags');
        const entryListContainer = document.getElementById('entry-list');
        const jsonPreview = document.getElementById('json-preview');
        
        // Buttons
        const newEntryButton = document.getElementById('new-entry-button');
        const saveEntryButton = document.getElementById('save-entry-button');
        const deleteEntryButton = document.getElementById('delete-entry-button');
        const saveLorebookButton = document.getElementById('save-lorebook-button');
        const loadLorebookFile = document.getElementById('load-lorebook-file');
        const uploadToProxyButton = document.getElementById('upload-to-proxy-button');
        
        // Lorebook metadata changes
        lorebookNameInput.addEventListener('input', () => {
            lorebook.meta.name = lorebookNameInput.value;
            updateJsonPreview();
        });
        
        lorebookDescInput.addEventListener('input', () => {
            lorebook.meta.description = lorebookDescInput.value;
            updateJsonPreview();
        });
        
        // Keyword management
        function addKeyword(input, list, container) {
            const keyword = input.value.trim();
            if (keyword && !list.includes(keyword)) {
                list.push(keyword);
                updateKeywordTags(list, container);
                input.value = '';
            }
        }
        
        function removeKeyword(keyword, list, container) {
            const index = list.indexOf(keyword);
            if (index !== -1) {
                list.splice(index, 1);
                updateKeywordTags(list, container);
            }
        }
        
        function updateKeywordTags(list, container) {
            container.innerHTML = '';
            list.forEach(keyword => {
                const tag = document.createElement('div');
                tag.className = 'key-tag';
                tag.innerHTML = `${keyword} <span class="remove-key">&times;</span>`;
                
                const removeButton = tag.querySelector('.remove-key');
                removeButton.addEventListener('click', () => {
                    removeKeyword(keyword, list, container);
                });
                
                container.appendChild(tag);
            });
        }
        
        // Add keyword buttons
        document.getElementById('add-keyword-button').addEventListener('click', () => {
            addKeyword(keywordInput, keywordsList, keywordTagsContainer);
        });
        
        document.getElementById('add-secondary-keyword-button').addEventListener('click', () => {
            addKeyword(secondaryKeywordInput, secondaryKeywordsList, secondaryKeywordTagsContainer);
        });
        
        // Add keyword on Enter
        keywordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                addKeyword(keywordInput, keywordsList, keywordTagsContainer);
            }
        });
        
        secondaryKeywordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                addKeyword(secondaryKeywordInput, secondaryKeywordsList, secondaryKeywordTagsContainer);
            }
        });

        // Lorebook Tag management
        function updateLorebookTagDisplay() {
            lorebookTagsContainer.innerHTML = '';
            lorebookTagsList.forEach(tagText => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag'; // Wiederverwendung der .tag Klasse f√ºr das Aussehen
                tagElement.textContent = tagText;
                const removeButton = document.createElement('span');
                removeButton.className = 'remove-key'; // Wiederverwendung f√ºr das Aussehen des Schlie√üen-Buttons
                removeButton.innerHTML = '&times;';
                removeButton.style.marginLeft = '8px'; // Etwas mehr Abstand
                removeButton.style.cursor = 'pointer';
                removeButton.onclick = () => removeLorebookTag(tagText);
                tagElement.appendChild(removeButton);
                lorebookTagsContainer.appendChild(tagElement);
            });
            lorebook.meta.tags = [...lorebookTagsList]; // Synchronisiere mit dem lorebook Objekt
            updateJsonPreview();
        }

        function addLorebookTag() {
            const tagText = lorebookTagsInput.value.trim();
            if (tagText && !lorebookTagsList.includes(tagText)) {
                lorebookTagsList.push(tagText);
                lorebookTagsInput.value = '';
                updateLorebookTagDisplay();
            }
        }

        function removeLorebookTag(tagText) {
            lorebookTagsList = lorebookTagsList.filter(t => t !== tagText);
            updateLorebookTagDisplay();
        }

        addLorebookTagButton.addEventListener('click', addLorebookTag);
        lorebookTagsInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Verhindert Formular-Submit, falls vorhanden
                addLorebookTag();
            }
        });
        
        // Entry management
        function resetEntryForm() {
            entryNameInput.value = '';
            keywordsList = [];
            secondaryKeywordsList = [];
            entryContentInput.value = '';
            alwaysActiveToggle.checked = false;
            disabledToggle.checked = false;
            entryOrderInput.value = 100;
            
            updateKeywordTags(keywordsList, keywordTagsContainer);
            updateKeywordTags(secondaryKeywordsList, secondaryKeywordTagsContainer);
            
            currentEntryId = null;
        }
        
        function selectEntry(entryId) {
            if (entryId === currentEntryId) return;
            
            currentEntryId = entryId;
            const entry = lorebook.entries[entryId];
            
            entryNameInput.value = entry.name || '';
            keywordsList = [...entry.key || []];
            secondaryKeywordsList = [...entry.keysecondary || []];
            entryContentInput.value = entry.content || '';
            alwaysActiveToggle.checked = entry.constant || false;
            disabledToggle.checked = entry.disable || false;
            entryOrderInput.value = entry.order || 100;
            
            updateKeywordTags(keywordsList, keywordTagsContainer);
            updateKeywordTags(secondaryKeywordsList, secondaryKeywordTagsContainer);
            
            // Highlight selected entry in list
            const entryItems = entryListContainer.querySelectorAll('.entry-item');
            entryItems.forEach(item => {
                if (item.getAttribute('data-id') === entryId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        function updateEntryList() {
            entryListContainer.innerHTML = '';
            
            if (Object.keys(lorebook.entries).length === 0) {
                entryListContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-file-text-o"></i>
                        <p>No entries yet. Create your first entry!</p>
                    </div>
                `;
                return;
            }
            
            for (const [id, entry] of Object.entries(lorebook.entries)) {
                const entryItem = document.createElement('div');
                entryItem.className = 'entry-item';
                if (id === currentEntryId) {
                    entryItem.classList.add('active');
                }
                entryItem.setAttribute('data-id', id);
                
                const badges = [];
                if (entry.constant) badges.push(`<span class="badge badge-primary">Always</span>`);
                if (entry.disable) badges.push(`<span class="badge badge-warning">Disabled</span>`);
                
                entryItem.innerHTML = `
                    <div class="entry-item-header">
                        <div class="entry-item-title">${entry.name || `Entry ${id}`}</div>
                        <div>${badges.join(' ')}</div>
                    </div>
                    <div class="entry-item-content">${entry.content?.substring(0, 50) || ''}${entry.content?.length > 50 ? '...' : ''}</div>
                `;
                
                entryItem.addEventListener('click', () => {
                    selectEntry(id);
                });
                
                entryListContainer.appendChild(entryItem);
            }
        }
        
        function saveEntry() {
            if (!entryNameInput.value) {
                alert('Please enter a name for this entry');
                return;
            }
            
            if (keywordsList.length === 0 && !alwaysActiveToggle.checked) {
                alert('Please add at least one keyword or mark the entry as "Always Active"');
                return;
            }
            
            if (!entryContentInput.value) {
                alert('Please enter content for this entry');
                return;
            }
            
            // Create or update entry
            if (currentEntryId === null) {
                // Create new entry
                const newId = Date.now().toString();
                lorebook.entries[newId] = {
                    uid: Object.keys(lorebook.entries).length,
                    name: entryNameInput.value,
                    key: keywordsList,
                    keysecondary: secondaryKeywordsList,
                    content: entryContentInput.value,
                    constant: alwaysActiveToggle.checked,
                    selective: false,
                    order: parseInt(entryOrderInput.value),
                    position: 0,
                    disable: disabledToggle.checked
                };
                currentEntryId = newId;
            } else {
                // Update existing entry
                lorebook.entries[currentEntryId] = {
                    ...lorebook.entries[currentEntryId],
                    name: entryNameInput.value,
                    key: keywordsList,
                    keysecondary: secondaryKeywordsList,
                    content: entryContentInput.value,
                    constant: alwaysActiveToggle.checked,
                    order: parseInt(entryOrderInput.value),
                    disable: disabledToggle.checked
                };
            }
            
            updateEntryList();
            updateJsonPreview();
        }
        
        function deleteEntry() {
            if (!currentEntryId) return;
            
            if (confirm('Are you sure you want to delete this entry?')) {
                delete lorebook.entries[currentEntryId];
                resetEntryForm();
                updateEntryList();
                updateJsonPreview();
            }
        }
        
        function updateJsonPreview() {
            // Create a clean version for export
            const currentMetaForSave = { ...lorebook.meta, tags: Array.isArray(lorebook.meta.tags) ? lorebook.meta.tags : [] };
            const exportLorebook = {
                entries: {},
                meta: currentMetaForSave
            };
            
            for (const [id, entry] of Object.entries(lorebook.entries)) {
                // Create a copy without the 'name' field (for UI only)
                const exportEntry = {...entry};
                if ('name' in exportEntry) {
                    delete exportEntry.name;
                }
                exportLorebook.entries[id] = exportEntry;
            }
            
            jsonPreview.textContent = JSON.stringify(exportLorebook, null, 2);
            
            // Also update the upload modal preview
            document.getElementById('upload-json-preview').textContent = JSON.stringify(exportLorebook, null, 2);
        }
        
        // Event listeners for buttons
        newEntryButton.addEventListener('click', () => {
            resetEntryForm();
            document.querySelectorAll('.entry-item').forEach(item => {
                item.classList.remove('active');
            });
        });
        
        saveEntryButton.addEventListener('click', saveEntry);
        deleteEntryButton.addEventListener('click', deleteEntry);
        
        saveLorebookButton.addEventListener('click', () => {
            if (Object.keys(lorebook.entries).length === 0) {
                alert('Your lorebook is empty. Please add at least one entry.');
                return;
            }
            
            // Create a clean version for export
            const currentMetaForSave = { ...lorebook.meta, tags: Array.isArray(lorebook.meta.tags) ? lorebook.meta.tags : [] };
            const exportLorebook = {
                entries: {},
                meta: currentMetaForSave
            };
            
            for (const [id, entry] of Object.entries(lorebook.entries)) {
                // Create a copy without the 'name' field (for UI only)
                const exportEntry = {...entry};
                if ('name' in exportEntry) {
                    delete exportEntry.name;
                }
                exportLorebook.entries[id] = exportEntry;
            }
            
            // Convert to JSON and download
            const lorebookJson = JSON.stringify(exportLorebook, null, 2);
            const blob = new Blob([lorebookJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${lorebook.meta.name.replace(/\s+/g, '_').toLowerCase() || 'lorebook'}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        loadLorebookFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const loadedLorebook = JSON.parse(event.target.result);
                    
                    if (!loadedLorebook.entries) {
                        throw new Error('Invalid lorebook format: missing entries object');
                    }
                    
                    // Reset current state
                    lorebook = {
                        entries: {},
                        meta: {
                            name: loadedLorebook.meta?.name || 'Imported Lorebook',
                            description: loadedLorebook.meta?.description || '',
                            tags: Array.isArray(loadedLorebook.meta?.tags) ? loadedLorebook.meta.tags : [] // Lade Tags
                        }
                    };
                    
                    lorebookTagsList = [...lorebook.meta.tags]; // Synchronisiere lorebookTagsList
                    updateLorebookTagDisplay(); // Aktualisiere die Anzeige der Tags

                    // Load entries
                    for (const [id, entry] of Object.entries(loadedLorebook.entries)) {
                        // Add name field for UI
                        let name = '';
                        if (entry.comment) {
                            name = entry.comment;
                        } else if (entry.key && entry.key.length > 0) {
                            name = entry.key[0];
                        } else {
                            name = `Entry ${id}`;
                        }
                        
                        lorebook.entries[id] = {
                            ...entry,
                            name
                        };
                    }
                    
                    // Update UI
                    lorebookNameInput.value = lorebook.meta.name;
                    lorebookDescInput.value = lorebook.meta.description;
                    // updateLorebookTagDisplay() wird bereits oben aufgerufen beim Setzen von lorebookTagsList
                    resetEntryForm();
                    updateEntryList();
                    updateJsonPreview();
                    
                    alert(`Lorebook loaded successfully with ${Object.keys(lorebook.entries).length} entries.`);
                } catch (error) {
                    alert(`Error loading lorebook: ${error.message}`);
                }
            };
            reader.readAsText(file);
            
            // Reset the file input
            e.target.value = '';
        });
        
        // Upload to Proxy button and modal
        const uploadModal = document.getElementById('upload-modal');
        const modalCloseButtons = document.querySelectorAll('.modal-close, .modal-cancel-button');
        const modalUploadButton = document.querySelector('.modal-upload-button');
        const modalPublicToggle = document.getElementById('modal-public-toggle');
        
        uploadToProxyButton.addEventListener('click', () => {
            if (Object.keys(lorebook.entries).length === 0) {
                alert('Your lorebook is empty. Please add at least one entry.');
                return;
            }
            
            // Sync the public toggle with the main form
            modalPublicToggle.checked = publicToggle.checked;
            
            // Update the JSON preview in the modal
            updateJsonPreview();
            
            // Show the modal
            uploadModal.style.display = 'flex';
        });
        
        modalCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                // General close for all modals that use this class
                if (uploadModal) uploadModal.style.display = 'none';
                
                const usedLorebookModal = document.getElementById('used-lorebook-modal');
                if (usedLorebookModal) usedLorebookModal.style.display = 'none';
                
                if (lorebookDetailsModal) lorebookDetailsModal.style.display = 'none';
            });
        });
        
        // Ensure the specific close button for used-lorebook-modal still works
        const usedLorebookModalCloseButton = document.querySelector('#used-lorebook-modal .modal-close-button');
        if (usedLorebookModalCloseButton) {
            usedLorebookModalCloseButton.addEventListener('click', () => {
                const usedLorebookModal = document.getElementById('used-lorebook-modal');
                if (usedLorebookModal) usedLorebookModal.style.display = 'none';
            });
        }
         // Ensure the specific close button for details-modal still works
        const detailsModalCloseButton = document.querySelector('#lorebook-details-modal .modal-close-button');
        if (detailsModalCloseButton) {
            detailsModalCloseButton.addEventListener('click', () => {
                if (lorebookDetailsModal) lorebookDetailsModal.style.display = 'none';
            });
        }

        modalUploadButton.addEventListener('click', async () => {
            const isEditing = uploadToProxyButton.dataset.editingCode;
            const codeToUpdate = isEditing || null;

            // Create a clean version for export/update
            const payload = {
                entries: {},
                meta: {
                    ...lorebook.meta, // Nimmt Name, Beschreibung etc. aus dem Creator-Formular
                    public: modalPublicToggle.checked, // Nimmt den Status aus dem Modal
                    tags: [...lorebookTagsList] // Nimmt die aktuellen Tags
                }
            };
            
            for (const [id, entry] of Object.entries(lorebook.entries)) {
                const exportEntry = {...entry};
                delete exportEntry.name; // UI-only 'name' entfernen
                payload.entries[id] = exportEntry;
            }

            // UI Feedback f√ºr den Upload-Button
            modalUploadButton.disabled = true;
            modalUploadButton.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${isEditing ? 'Updating...' : 'Uploading...'}`;

            try {
                let response;
                let apiUrl = '/api/lorebook';
                let httpMethod = 'POST';

                if (isEditing) {
                    apiUrl = `/api/admin/lorebook/${codeToUpdate}`;
                    httpMethod = 'PUT';
                }
                
                const token = localStorage.getItem('adminToken'); // F√ºr PUT (Admin) erforderlich

                response = await fetch(apiUrl, {
                    method: httpMethod,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(isEditing && token && { 'Authorization': `Bearer ${token}` }) // Token nur f√ºr Admin-Update
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    uploadModal.style.display = 'none';
                    
                    if (isEditing) {
                        alert(`Lorebook ${codeToUpdate} updated successfully!`);
                        // Aktualisiere die Admin-Ansicht, um die √Ñnderungen widerzuspiegeln
                        loadAdminLorebooks();
                        // Optional: Zur√ºck zur Admin-Seite springen
                        showPage('admin-page');
                        const adminNavLink = document.getElementById('nav-admin');
                        if(adminNavLink) adminNavLink.classList.add('active');

                    } else {
                        document.getElementById('used-lorebook-code').innerHTML = `<LORE:${data.code}>`;
                        document.getElementById('used-lorebook-modal').style.display = 'flex';
                    }
                    
                    if (modalPublicToggle.checked || (isEditing && payload.meta.public)) {
                        loadPublicLorebooks(); // √ñffentliche Liste aktualisieren
                    }
                     // Reset editing state
                    uploadToProxyButton.removeAttribute('data-editing-code');
                    uploadToProxyButton.innerHTML = '<i class="fa fa-cloud-upload"></i> Upload to Proxy';

                } else {
                    if (response.status === 401 && isEditing) {
                        adminLogout();
                        adminLoginLink.click();
                        alert(`Failed to update lorebook: ${data.message || 'Session expired. Please login again.'}`);
                    } else {
                        alert(`Error ${isEditing ? 'updating' : 'uploading'} lorebook: ${data.message || 'Unknown server error'}`);
                    }
                }
            } catch (error) {
                console.error(`Error ${isEditing ? 'updating' : 'uploading'} lorebook:`, error);
                alert(`Error: ${error.message}`);
            } finally {
                modalUploadButton.disabled = false;
                modalUploadButton.innerHTML = isEditing ? 'Update Lorebook on Proxy' : 'Upload to Proxy';
            }
        });
        
        // Initialize the UI
        updateEntryList();
        updateJsonPreview();
        
        // Initial load
        function checkInitialAdminState() {
            const token = localStorage.getItem('adminToken');
            // Hier k√∂nnte man einen stillen Ping an einen Admin-Check-Endpunkt senden, um den Token serverseitig zu validieren.
            // F√ºrs Erste: Wenn Token da ist, gehen wir davon aus, dass der User eingeloggt sein k√∂nnte.
            // Die API-Calls werden den Token validieren und ggf. den Logout erzwingen.
            if (token) {
                isAdminLoggedIn = true;
                updateAdminNavOnLogin(); // Stellt sicher, dass Admin-Tab und Logout-Link angezeigt werden
            } else {
                isAdminLoggedIn = false;
                updateAdminNavOnLogin(); // Stellt sicher, dass Admin-Tab und Logout-Link entfernt werden
            }
        }
        checkInitialAdminState();
        showPage('home-page'); // Show home page by default
        loadPublicLorebooks(); // Load public lorebooks on initial page load
    </script>
</body>
</html>
